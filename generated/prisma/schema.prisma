// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ 枚举定义 ============

// 习惯类型
enum HabitType {
  BUILD // 养成
  BREAK // 戒除
}

// 习惯状态
enum HabitStatus {
  ACTIVE // 活跃中
  PAUSED // 暂停
  GRADUATED // 已毕业（习惯已养成）
  ARCHIVED // 已归档
}

// 完成级别枚举（弹性打卡）
enum CompletionLevel {
  MINIMUM // 完成最低标准
  STANDARD // 完成当前阶段标准
  EXCEEDED // 超额完成
}

// 庆祝方式分类
enum CelebrationCategory {
  VERBAL // 语言类：说"太棒了"
  PHYSICAL // 动作类：挥拳、跳舞
  MENTAL // 想象类：想象烟花绽放
  SENSORY // 感官类：深呼吸、闭眼感受
}

// 愿望状态
enum AspirationStatus {
  EXPLORING // 探索中
  ACTIVE // 进行中
  ACHIEVED // 已达成
  ABANDONED // 已放弃
}

// ============ NextAuth.js 模型 ============

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============ 核心业务模型 ============

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // 偏好设置
  preferences Json? // { soundEnabled, theme, ... }

  // 关联
  accounts     Account[]
  sessions     Session[]
  aspirations  Aspiration[]
  habits       Habit[]
  habitLogs    HabitLog[]
  routine      DailyRoutine?
  celebrations UserCelebration[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 习惯模型 - 简化版 ABC 配方
model Habit {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        HabitType
  name        String    @db.VarChar(100)
  description String?
  category    String?   @db.VarChar(50)

  // ABC 配方（福格习惯配方）
  anchor      String? // 锚点行为："在我【锚点】之后"
  behavior    String? // 微行为："我会【行为】"
  celebration String? // 庆祝方式："为了让大脑记住，我要【庆祝】"

  // 关联愿望
  aspirationId String?
  aspiration   Aspiration? @relation(fields: [aspirationId], references: [id], onDelete: SetNull)

  // 进度追踪
  currentPhase Int @default(1)

  status HabitStatus @default(ACTIVE)
  logs   HabitLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([aspirationId])
}

// 打卡记录模型 - 简化版
model HabitLog {
  id        String   @id @default(cuid())
  habitId   String
  habit     Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  loggedAt  DateTime @db.Date
  completed Boolean

  // 弹性打卡
  completionLevel CompletionLevel @default(MINIMUM)
  actualBehavior  String? // 实际做了什么

  // 福格反馈信号
  wantedMore Boolean? // 想做更多？（进阶信号）
  feltEasy   Boolean? // 觉得轻松？（进阶信号）

  // 庆祝相关
  shineScore Int? // 发光感评分 1-5
  moodBefore Int? // 执行前情绪 1-5
  moodAfter  Int? // 执行后情绪 1-5
  note       String? // 备注

  createdAt DateTime @default(now())

  @@unique([habitId, loggedAt])
  @@index([habitId])
  @@index([userId])
  @@index([loggedAt])
}

// 愿望模型
model Aspiration {
  id          String           @id @default(cuid())
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  description String // 愿望描述
  clarified   String? // 明确后的愿望
  category    String? // 分类
  status      AspirationStatus @default(EXPLORING)
  progress    Int              @default(0) // 进度百分比

  // AI 探索数据 { behaviors, focusMap, goldenBehavior, summary }
  explorationData Json?

  habits     Habit[]
  achievedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

// 庆祝方式库
model CelebrationMethod {
  id        String              @id @default(cuid())
  category  CelebrationCategory
  content   String // 庆祝方式描述
  emoji     String? // 表情符号
  isBuiltIn Boolean             @default(true)

  userFavorites UserCelebration[]

  @@index([category])
}

// 用户收藏的庆祝方式
model UserCelebration {
  id                  String            @id @default(cuid())
  userId              String
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  celebrationMethodId String
  celebrationMethod   CelebrationMethod @relation(fields: [celebrationMethodId], references: [id], onDelete: Cascade)
  isDefault           Boolean           @default(false)
  useCount            Int               @default(0)

  @@unique([userId, celebrationMethodId])
  @@index([userId])
}

// 日程清单（锚点来源）
model DailyRoutine {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 活动列表 [{ name, time, frequency, location, timeSlot }]
  activities Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
