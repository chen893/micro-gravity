  # ä¹ æƒ¯å…»æˆ Web åº”ç”¨äº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆPRDï¼‰

  **åŸºäºç¦æ ¼è¡Œä¸ºæ¨¡å‹ä¸ AI SDK v6 çš„æ™ºèƒ½ä¹ æƒ¯ç®¡ç†ç³»ç»Ÿ**

  ---

  | æ–‡æ¡£ä¿¡æ¯ | |
  |---------|---|
  | ç‰ˆæœ¬ | v2.5 |
  | æ—¥æœŸ | 2025-11-29 |
  | çŠ¶æ€ | v1.5 å®ç°è¿›åº¦æ›´æ–° |
  | æŠ€æœ¯æ¡†æ¶ | T3 Stack + Vercel AI SDK v6 |

  ---

  ## ç›®å½•

  1. [æ¦‚è¿°](#1-æ¦‚è¿°)
  2. [ç¦æ ¼è¡Œä¸ºæ¨¡å‹ä¸äº§å“æ˜ å°„](#2-ç¦æ ¼è¡Œä¸ºæ¨¡å‹ä¸äº§å“æ˜ å°„)
  3. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#3-ç³»ç»Ÿæ¶æ„è®¾è®¡)
  4. [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—](#4-æ ¸å¿ƒåŠŸèƒ½æ¨¡å—)
     - 4.1 AI å¯¹è¯å¼ä¹ æƒ¯é…ç½®
     - 4.2 æ™ºèƒ½æé†’ç³»ç»Ÿ
     - 4.3 åŠ¨æœºç»´æŠ¤å¼•æ“
     - 4.4 èƒ½åŠ›è¯„ä¼°ä¸ä»»åŠ¡æ‹†è§£
     - 4.5 åä¹ æƒ¯æˆ’é™¤ç³»ç»Ÿ
     - 4.6 AI æ•™ç»ƒå¯¹è¯
     - 4.7 æ•°æ®æ´å¯Ÿ
     - 4.8 å‘¨æœŸæŠ¥å‘Šç³»ç»Ÿ (v1.5) â­
     - 4.9 è¿›é˜¶åˆ†æç³»ç»Ÿ (v1.5) â­
  5. [AI SDK æŠ€æœ¯å®ç°](#5-ai-sdk-æŠ€æœ¯å®ç°)
  6. [æ•°æ®åº“è®¾è®¡](#6-æ•°æ®åº“è®¾è®¡)
  7. [éåŠŸèƒ½éœ€æ±‚](#7-éåŠŸèƒ½éœ€æ±‚)
  8. [ç‰ˆæœ¬è¿­ä»£è§„åˆ’](#8-ç‰ˆæœ¬è¿­ä»£è§„åˆ’)
  9. [v1.5 å®ç°è¿›åº¦æ€»ç»“](#9-v15-å®ç°è¿›åº¦æ€»ç»“) â­ æ–°å¢

  ---

  ## 1. æ¦‚è¿°

  ### 1.1 èƒŒæ™¯ä¸ç›®æ ‡

  #### å¸‚åœºç—›ç‚¹

  | ç—›ç‚¹ | ç°æœ‰äº§å“é—®é¢˜ | æœ¬äº§å“è§£å†³æ–¹æ¡ˆ |
  |-----|------------|--------------|
  | åŠ¨æœºè¡°å‡ | ç®€å•æ‰“å¡ï¼Œæ— æŒç»­æ¿€åŠ± | AI åŠ¨æ€æ„ŸçŸ¥åŠ¨æœºçŠ¶æ€ï¼Œä¸ªæ€§åŒ–æ¿€åŠ± |
  | èƒ½åŠ›é”™é… | å›ºå®šç›®æ ‡ï¼Œä¸è€ƒè™‘ä¸ªä½“å·®å¼‚ | æ™ºèƒ½ä»»åŠ¡æ‹†è§£ï¼Œå¾®ä¹ æƒ¯æ¸è¿›è®¾è®¡ |
  | æç¤ºå¤±æ•ˆ | æœºæ¢°å®šæ—¶æ¨é€ | æƒ…å¢ƒæ„ŸçŸ¥ï¼Œæœ€ä½³æ—¶æœºé¢„æµ‹ |
  | æˆ’é™¤å›°éš¾ | ç¼ºä¹ç§‘å­¦æ–¹æ³•è®ºæ”¯æ’‘ | åŸºäºç¦æ ¼æ¨¡å‹çš„è§¦å‘é“¾æ‰“æ–­ç­–ç•¥ |

  #### äº§å“ç›®æ ‡

  æ„å»ºåŸºäº **ç¦æ ¼è¡Œä¸ºæ¨¡å‹ï¼ˆB=MAPï¼‰** çš„æ™ºèƒ½ä¹ æƒ¯ç®¡ç†ç³»ç»Ÿï¼š

  - **Mï¼ˆMotivationï¼‰**ï¼šAI é©±åŠ¨çš„åŠ¨æœºè¯Šæ–­ä¸ä¸ªæ€§åŒ–æ¿€åŠ±
  - **Aï¼ˆAbilityï¼‰**ï¼šæ™ºèƒ½ä»»åŠ¡æ‹†è§£ä¸éš¾åº¦åŠ¨æ€è°ƒæ•´
  - **Pï¼ˆPromptï¼‰**ï¼šæƒ…å¢ƒæ„ŸçŸ¥çš„æ™ºèƒ½è§¦å‘ç³»ç»Ÿ

  ### 1.2 ç›®æ ‡ç”¨æˆ·

  | ç”¨æˆ·ç¾¤ä½“ | æ ¸å¿ƒåœºæ™¯ |
  |---------|---------|
  | èŒåœºäººç¾¤ | æ—©èµ·ã€é˜…è¯»ã€æ—¶é—´ç®¡ç† |
  | å¥åº·è¿½æ±‚è€… | è¿åŠ¨ã€å†¥æƒ³ã€å¥åº·é¥®é£Ÿ |
  | æˆ’é™¤éœ€æ±‚è€… | æˆ’çƒŸã€å‡å°‘æ‰‹æœºã€æ§åˆ¶æ¶ˆè´¹ |
  | è‡ªæˆ‘æå‡è€… | å­¦ä¹ æŠ€èƒ½ã€å†™ä½œã€ä¸“æ³¨åŠ› |

  ### 1.3 æŠ€æœ¯é€‰å‹

  ```
  Frontend
  â”œâ”€â”€ Next.js 15 (App Router + Turbopack)
  â”œâ”€â”€ React 19 + TypeScript
  â”œâ”€â”€ Tailwind CSS v4 + shadcn/ui
  â”œâ”€â”€ @ai-sdk/react (useChat hook)
  â””â”€â”€ Recharts (æ•°æ®å¯è§†åŒ–)

  Backend
  â”œâ”€â”€ tRPC v11 (ç±»å‹å®‰å…¨API)
  â”œâ”€â”€ Vercel AI SDK v6 (ai package)
  â”œâ”€â”€ Prisma ORM
  â”œâ”€â”€ PostgreSQL
  â”œâ”€â”€ NextAuth.js v5 (è®¤è¯)
  â””â”€â”€ Zod (SchemaéªŒè¯)

  Infrastructure
  â”œâ”€â”€ Vercel (éƒ¨ç½²)
  â”œâ”€â”€ Vercel AI Gateway (ç»Ÿä¸€æ¨¡å‹è®¿é—®)
  â””â”€â”€ PostgreSQL (æ•°æ®åº“)
  ```

  ---

  ## 2. ç¦æ ¼è¡Œä¸ºæ¨¡å‹ä¸äº§å“æ˜ å°„

  ### 2.1 æ ¸å¿ƒå…¬å¼

  ```
  B = MAP

  è¡Œä¸ºå‘ç”Ÿ = åŠ¨æœº(Motivation) Ã— èƒ½åŠ›(Ability) Ã— æç¤º(Prompt)
  ```

  ### 2.2 è¡Œä¸ºè®¾è®¡æ›²çº¿

  ```
  åŠ¨æœº â†‘
    â”‚      â˜… è¡Œä¸ºå‘ç”ŸåŒº
    â”‚    â•±â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”‚  â•± è¡ŒåŠ¨çº¿
    â”‚â•±
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ èƒ½åŠ›ï¼ˆç®€å•ç¨‹åº¦ï¼‰

  æ¡ä»¶ï¼šå½“ åŠ¨æœºÃ—èƒ½åŠ› â‰¥ è¡ŒåŠ¨é˜ˆå€¼ ä¸” å­˜åœ¨æœ‰æ•ˆæç¤º â†’ è¡Œä¸ºå‘ç”Ÿ
  ```

  ### 2.3 äº§å“åŠŸèƒ½æ˜ å°„

  | ç¦æ ¼è¦ç´  | ç†è®ºæ ¸å¿ƒ | AI åŠŸèƒ½å®ç° |
  |---------|---------|-----------|
  | **åŠ¨æœº(M)** | æ„‰æ‚¦/ç—›è‹¦ã€å¸Œæœ›/ææƒ§ã€ç¤¾ä¼šè®¤åŒ | åŠ¨æœºç±»å‹è¯Šæ–­ã€ä¸ªæ€§åŒ–æ¿€åŠ±æ–‡æ¡ˆç”Ÿæˆã€æ„¿æ™¯å¯è§†åŒ– |
  | **èƒ½åŠ›(A)** | æ—¶é—´ã€é‡‘é’±ã€ä½“åŠ›ã€è„‘åŠ›ã€ç¤¾ä¼šåå·®ã€éå¸¸è§„æ€§ | å¾®ä¹ æƒ¯è®¾è®¡ã€æ™ºèƒ½ä»»åŠ¡æ‹†è§£ã€éš¾åº¦åŠ¨æ€è°ƒæ•´ |
  | **æç¤º(P)** | ä¿¡å·å‹ã€ä¾¿åˆ©å‹ã€ç«èŠ±å‹ | æœ€ä½³æ—¶æœºé¢„æµ‹ã€é”šå®šä¹ æƒ¯è®¾è®¡ã€æƒ…å¢ƒåŒ–æé†’ç”Ÿæˆ |

  ### 2.4 å…»æˆ vs æˆ’é™¤ç­–ç•¥å¯¹æ¯”

  | ç»´åº¦ | ä¹ æƒ¯å…»æˆ | åä¹ æƒ¯æˆ’é™¤ |
  |-----|---------|-----------|
  | åŠ¨æœºç­–ç•¥ | å¼ºåŒ–æ­£å‘æ„¿æ™¯ | å¼ºåŒ–ç—›è‹¦æ„ŸçŸ¥ |
  | èƒ½åŠ›ç­–ç•¥ | é™ä½è¡ŒåŠ¨é—¨æ§› | æé«˜æ‰§è¡Œéšœç¢ |
  | æç¤ºç­–ç•¥ | åˆ›é€ æ–°è§¦å‘ç‚¹ | æ‰“æ–­è§¦å‘é“¾ |

  ---

  ## 3. ç³»ç»Ÿæ¶æ„è®¾è®¡

  ### 3.1 æ•´ä½“æ¶æ„

  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                      Frontend (Next.js)                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
  â”‚  â”‚  Chat UI     â”‚  â”‚  Dashboard   â”‚  â”‚  Progress    â”‚          â”‚
  â”‚  â”‚  (useChat)   â”‚  â”‚  (ä¹ æƒ¯ç®¡ç†)   â”‚  â”‚  (æ•°æ®å¯è§†åŒ–) â”‚          â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   API Layer (tRPC v11)                          â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚  chatRouter       - AIå¯¹è¯ç«¯ç‚¹ (streamText)              â”‚  â”‚
  â”‚  â”‚  habitRouter      - ä¹ æƒ¯CRUD                             â”‚  â”‚
  â”‚  â”‚  logRouter        - æ‰“å¡è®°å½•                              â”‚  â”‚
  â”‚  â”‚  insightRouter    - æ™ºèƒ½æ´å¯Ÿ (generateObject)            â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    AI SDK Core Layer                            â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚   streamText   â”‚  â”‚ generateObject â”‚  â”‚     tool()     â”‚    â”‚
  â”‚  â”‚   (å¯¹è¯æµå¼)    â”‚  â”‚  (ç»“æ„åŒ–è¾“å‡º)   â”‚  â”‚   (å·¥å…·è°ƒç”¨)    â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                              â”‚                                  â”‚
  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
  â”‚                    â”‚ Vercel AI Gateway â”‚                       â”‚
  â”‚                    â”‚  (ç»Ÿä¸€æ¨¡å‹è®¿é—®)    â”‚                       â”‚
  â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                     Data Layer                                  â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
  â”‚  â”‚     PostgreSQL       â”‚  â”‚    Prisma ORM        â”‚            â”‚
  â”‚  â”‚                      â”‚  â”‚         â”‚            â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

  ### 3.2 æ¨¡å‹é…ç½®ï¼ˆVercel AI Gatewayï¼‰

  ```env
  # .env.local
  AI_GATEWAY_API_KEY=your-api-key
  ```

  ```typescript
  // ç›´æ¥åœ¨è°ƒç”¨æ—¶æŒ‡å®šæ¨¡å‹ï¼Œæ— éœ€å•ç‹¬é…ç½®æ–‡ä»¶
  // æ”¯æŒçš„æ¨¡å‹æ ¼å¼ï¼šprovider/model-name
  model: 'openai/gpt-4o'
  model: 'anthropic/claude-sonnet-4-20250514'
  model: 'google/gemini-2.5-flash'
  ```

  > **è®¾è®¡è¯´æ˜**ï¼šä½¿ç”¨ Vercel AI Gateway ç»Ÿä¸€ç®¡ç†æ¨¡å‹è®¿é—®ï¼Œé€šè¿‡å•ä¸€ API Key è®¿é—®å¤šä¸ªæä¾›å•†çš„æ¨¡å‹ã€‚åœ¨ä»£ç ä¸­ç›´æ¥æŒ‡å®šæ¨¡å‹å­—ç¬¦ä¸²ï¼Œä¾¿äºçµæ´»åˆ‡æ¢ã€‚

  ---

  ## 4. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

  ### 4.1 æ¨¡å—ä¸€ï¼šAI å¯¹è¯å¼ä¹ æƒ¯é…ç½®

  #### åŠŸèƒ½æ¦‚è¿°

  é€šè¿‡ AI å¯¹è¯å¼•å¯¼ç”¨æˆ·å®Œæˆä¹ æƒ¯åˆ›å»ºï¼Œæ›¿ä»£ä¼ ç»Ÿè¡¨å•æ–¹å¼ï¼ŒåŒæ—¶æ·±å…¥æŒ–æ˜ç”¨æˆ·åŠ¨æœºã€‚

  #### å¯¹è¯æµç¨‹

  ```
  Step 1: æ„å›¾é‡‡é›†
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AI: "ä½ å¥½ï¼æƒ³å…»æˆæ–°ä¹ æƒ¯ï¼Œè¿˜æ˜¯æ”¹æ‰ä¸€ä¸ªåä¹ æƒ¯ï¼Ÿ"  â”‚
  â”‚ ç”¨æˆ·: "æˆ‘æƒ³æ¯å¤©æ—©èµ·"                          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
  Step 2: åŠ¨æœºæ·±æŒ– (MAP-M)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AI: "æ—©èµ·å¯¹ä½ æ„å‘³ç€ä»€ä¹ˆï¼Ÿæ˜¯æƒ³æœ‰æ›´å¤šè‡ªå·±çš„      â”‚
  â”‚      æ—¶é—´ï¼Œè¿˜æ˜¯ä¸ºäº†å·¥ä½œæ•ˆç‡ï¼Ÿ"                 â”‚
  â”‚ ç”¨æˆ·: "æƒ³æœ‰æ—¶é—´çœ‹ä¹¦å­¦ä¹ "                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
  Step 3: èƒ½åŠ›è¯„ä¼° (MAP-A)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AI: "ä½ ç°åœ¨é€šå¸¸å‡ ç‚¹èµ·åºŠï¼Ÿç›®æ ‡æ˜¯å‡ ç‚¹ï¼Ÿ"         â”‚
  â”‚ ç”¨æˆ·: "ç°åœ¨8ç‚¹ï¼Œæƒ³6ç‚¹èµ·"                      â”‚
  â”‚ AI: "ä¸€ä¸‹æå‰2å°æ—¶æŒ‘æˆ˜è¾ƒå¤§ã€‚å»ºè®®ä»7:30å¼€å§‹ï¼Œ   â”‚
  â”‚      æ¯å‘¨æå‰15åˆ†é’Ÿï¼Œä½ è§‰å¾—å‘¢ï¼Ÿ"               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
  Step 4: è§¦å‘è®¾è®¡ (MAP-P)
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ AI: "æ™šä¸Šç¡å‰ä½ é€šå¸¸åšä»€ä¹ˆï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠ          â”‚
  â”‚      'å‡†å¤‡æ—©èµ·'é”šå®šåˆ°ä½ çš„ç¡å‰ä¹ æƒ¯ä¸Š"           â”‚
  â”‚ ç”¨æˆ·: "ä¼šåˆ·ä¸€ä¼šæ‰‹æœº"                          â”‚
  â”‚ AI: "é‚£æˆ‘ä»¬è®¾å®šï¼šå½“ä½ æ‹¿èµ·æ‰‹æœºå‡†å¤‡åˆ·æ—¶ï¼Œ        â”‚
  â”‚      å…ˆæŠŠæ˜å¤©çš„è¡£æœæ”¾åœ¨åºŠè¾¹ã€‚è¿™åªéœ€30ç§’ã€‚"     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

  #### æŠ€æœ¯å®ç°

  ```typescript
  // src/app/api/chat/route.ts
  import { streamText, convertToModelMessages, tool, UIMessage } from 'ai';
  import { z } from 'zod';
  import { db } from '@/server/db';
  import { auth } from '@/server/auth';

  export async function POST(req: Request) {
    const session = await auth();
    if (!session?.user) {
      return new Response('Unauthorized', { status: 401 });
    }

    const { messages }: { messages: UIMessage[] } = await req.json();

    const result = streamText({
      model: 'openai/gpt-4o',
      system: HABIT_COACH_SYSTEM_PROMPT,
      messages: convertToModelMessages(messages),
      tools: {
        createHabit: tool({
          description: 'å½“æ”¶é›†å®Œä¹ æƒ¯ä¿¡æ¯åï¼Œåˆ›å»ºä¹ æƒ¯é…ç½®',
          inputSchema: z.object({
            name: z.string().describe('ä¹ æƒ¯åç§°'),
            type: z.enum(['BUILD', 'BREAK']).describe('å…»æˆæˆ–æˆ’é™¤'),
            category: z.string().optional().describe('ä¹ æƒ¯åˆ†ç±»'),
            motivation: z.object({
              primaryType: z.enum(['PLEASURE', 'HOPE', 'SOCIAL']).describe('ä¸»è¦åŠ¨æœºç±»å‹'),
              deepReason: z.string().describe('æ·±å±‚åŸå› '),
              visionStatement: z.string().describe('æ„¿æ™¯å£°æ˜'),
              motivationScore: z.number().min(1).max(10).describe('å½“å‰åŠ¨æœºå¼ºåº¦'),
            }),
            ability: z.object({
              currentLevel: z.string().describe('å½“å‰æ°´å¹³'),
              targetLevel: z.string().describe('ç›®æ ‡æ°´å¹³'),
              microHabit: z.string().describe('å¾®ä¹ æƒ¯å®šä¹‰'),
              difficultyScore: z.number().min(1).max(10).describe('é¢„ä¼°éš¾åº¦'),
            }),
            prompt: z.object({
              anchorHabit: z.string().describe('é”šå®šä¹ æƒ¯'),
              triggerType: z.enum(['SIGNAL', 'FACILITATOR', 'SPARK']).describe('è§¦å‘ç±»å‹'),
              preferredTime: z.string().describe('åå¥½æ—¶é—´'),
            }),
          }),
          execute: async (habitConfig) => {
            // ä½¿ç”¨ Prisma åˆ›å»ºä¹ æƒ¯
            return db.habit.create({
              data: {
                ...habitConfig,
                userId: session.user.id,
              },
            });
          },
        }),
      },
    });

    return result.toUIMessageStreamResponse();
  }
  ```

  > **æ³¨æ„**: AI æµå¼å“åº”éœ€è¦é…åˆ Next.js API Route ä½¿ç”¨ï¼ŒtRPC ä¸»è¦å¤„ç†ä¹ æƒ¯ CRUD ç­‰æ ‡å‡†æ“ä½œã€‚å¯¹äº AI å¯¹è¯ï¼Œæ¨èä½¿ç”¨æ··åˆæ¨¡å¼ï¼š`/api/chat` å¤„ç†æµå¼ AI å“åº”ï¼ŒtRPC å¤„ç†æ•°æ®æ“ä½œã€‚

  ### 4.2 æ¨¡å—äºŒï¼šæ™ºèƒ½æé†’ç³»ç»Ÿ

  #### æé†’ç­–ç•¥çŸ©é˜µ

  ```
                      åŠ¨æœºæ°´å¹³
                  ä½        é«˜
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
          ä½   â”‚ ç«èŠ±å‹  â”‚ ä¿¡å·å‹  â”‚
    èƒ½åŠ›        â”‚ (æ¿€åŠ±+æŒ‡å¼•) â”‚ (ç®€å•æé†’) â”‚
    é—¨æ§›        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          é«˜   â”‚ ä¾¿åˆ©å‹  â”‚ ä¿¡å·å‹  â”‚
                â”‚ (é™ä½é—¨æ§›) â”‚ (ç®€å•æé†’) â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

  #### æ™ºèƒ½æ–‡æ¡ˆç”Ÿæˆ

  ```typescript
  // lib/ai/reminder.ts
  import { generateObject } from 'ai';
  import { z } from 'zod';

  const reminderSchema = z.object({
    content: z.string().describe('æé†’æ–‡æ¡ˆï¼Œ30-60å­—'),
    promptType: z.enum(['SIGNAL', 'FACILITATOR', 'SPARK']),
    actionGuidance: z.string().describe('å…·ä½“è¡ŒåŠ¨æŒ‡å¼•'),
  });

  export async function generateReminder(context: ReminderContext) {
    const { object } = await generateObject({
      model: 'openai/gpt-4o',
      system: `ä½ æ˜¯ä¹ æƒ¯æ•™ç»ƒï¼Œç²¾é€šç¦æ ¼è¡Œä¸ºæ¨¡å‹ã€‚
  æ ¹æ®ç”¨æˆ·å½“å‰çŠ¶æ€ç”Ÿæˆä¸ªæ€§åŒ–æé†’ã€‚
  - åŠ¨æœºç±»å‹: ${context.motivationType}
  - å½“å‰åŠ¨æœºæ°´å¹³: ${context.motivationLevel}/10
  - è¿ç»­å®Œæˆå¤©æ•°: ${context.streakDays}
  - æœ€è¿‘å®Œæˆç‡: ${context.recentRate}%`,
      prompt: `ä¸ºä¹ æƒ¯"${context.habitName}"ç”Ÿæˆæé†’æ–‡æ¡ˆ`,
      schema: reminderSchema,
    });

    return object;
  }
  ```

  #### ç¤ºä¾‹è¾“å‡ºå¯¹æ¯”

  | åœºæ™¯ | ä¼ ç»Ÿæé†’ | AI æ™ºèƒ½æé†’ |
  |-----|---------|-----------|
  | æ—©èµ·-åŠ¨æœºä½ | "è¯¥èµ·åºŠäº†ï¼" | "å°æï¼Œæ˜¨å¤©ä½ è¯´æƒ³åœ¨æ™‹å‡å‰è¯»å®Œé‚£æœ¬ä¹¦ã€‚ä»Šå¤©æ—©èµ·çš„30åˆ†é’Ÿï¼Œå°±æ˜¯ä½ é¢†å…ˆåŒé¾„äººçš„æ—¶åˆ»ã€‚" |
  | è¿åŠ¨-èƒ½åŠ›ä¸è¶³ | "è¿åŠ¨æ—¶é—´åˆ°ï¼" | "ä»Šå¤©ä¸ç”¨å»å¥èº«æˆ¿ã€‚ç©¿ä¸Šé‹ï¼Œåœ¨å°åŒºèµ°10åˆ†é’Ÿå°±ç®—å®Œæˆã€‚ä¸‹é›¨ï¼Ÿé‚£å°±å®¢å…5ä¸ªæ·±è¹²ã€‚" |
  | æˆ’çƒŸ-è§¦å‘æ—¶åˆ» | "åˆ«æŠ½çƒŸï¼" | "æ£€æµ‹åˆ°ä¼‘æ¯æ—¶é—´ã€‚æ·±å‘¼å¸3æ¬¡ï¼Œå–ä¸€å£æ°´ï¼Œç»™è‡ªå·±1åˆ†é’Ÿã€‚ä½ å·²ç»è¿ç»­3å¤©æˆåŠŸåº¦è¿‡è¿™ä¸ªæ—¶åˆ»äº†ã€‚" |

  ### 4.3 æ¨¡å—ä¸‰ï¼šåŠ¨æœºç»´æŠ¤å¼•æ“

  #### åŠ¨æœºæ³¢åŠ¨æ¨¡å‹

  ```
  åŠ¨æœºå¼ºåº¦
      â”‚
  10 â”€â”¤     â•­â”€â•®        â•­â”€â•®
      â”‚    â•±   â•²      â•±   â•²    â† AIæ¿€åŠ±å¹²é¢„
  7 â”€â”¤   â•±     â•²    â•±     â•²
      â”‚  â•±       â•²  â•±       â•²
  4 â”€â”¤ â•±         â•²â•±         â•²  â† è‡ªç„¶è¡°å‡
      â”‚â•±                       â•²
  1 â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¶é—´
      Day1    Day7   Day14   Day21

  å…³é”®å¹²é¢„ç‚¹:
  â”œâ”€â”€ Day 3: æ–°é²œæ„Ÿæ¶ˆé€€
  â”œâ”€â”€ Day 7: ç¬¬ä¸€ä¸ªé‡Œç¨‹ç¢‘
  â”œâ”€â”€ Day 14: å€¦æ€ é«˜å‘æœŸ
  â””â”€â”€ Day 21+: ä¹ æƒ¯åˆæ­¥å½¢æˆ
  ```

  #### æ¿€åŠ±å†…å®¹ç”Ÿæˆ

  ```typescript
  // lib/ai/motivation.ts
  import { generateObject } from 'ai';
  import { z } from 'zod';

  const motivationSchema = z.object({
    message: z.string().describe('æ¿€åŠ±æ–‡æ¡ˆï¼Œ50-100å­—'),
    motivationType: z.enum([
      'PLEASURE_GAIN',   // è·å¾—æ„‰æ‚¦
      'PAIN_AVOID',      // è§„é¿ç—›è‹¦
      'HOPE_FUTURE',     // å¸Œæœ›æ„¿æ™¯
      'FEAR_LOSS',       // æŸå¤±ææƒ§
      'SOCIAL_PROOF',    // ç¤¾ä¼šè®¤åŒ
    ]),
    actionSuggestion: z.string().describe('ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®'),
  });

  export async function generateMotivation(context: MotivationContext) {
    const { object } = await generateObject({
      model: 'openai/gpt-4o',
      system: `ä½ æ˜¯ä¹ æƒ¯æ•™ç»ƒã€‚æ ¹æ®ç”¨æˆ·çš„åŠ¨æœºç±»å‹å’Œå½“å‰çŠ¶æ€ï¼Œ
  ç”Ÿæˆèƒ½å¼•å‘å…±é¸£çš„æ¿€åŠ±å†…å®¹ã€‚
  ç”¨æˆ·æ·±å±‚åŠ¨æœº: ${context.deepReason}
  ç”¨æˆ·æ„¿æ™¯: ${context.visionStatement}`,
      prompt: `ç”¨æˆ·å·²è¿ç»­${context.streakDays}å¤©å®Œæˆ"${context.habitName}"ï¼Œ
  å½“å‰çŠ¶æ€: ${context.currentState}
  è¯·ç”Ÿæˆä¸ªæ€§åŒ–æ¿€åŠ±`,
      schema: motivationSchema,
    });

    return object;
  }
  ```

  ### 4.4 æ¨¡å—å››ï¼šèƒ½åŠ›è¯„ä¼°ä¸ä»»åŠ¡æ‹†è§£

  #### å…­ç»´èƒ½åŠ›è¯„ä¼°ï¼ˆç¦æ ¼æ¨¡å‹ï¼‰

  ```
          æ—¶é—´
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
    â”‚     â”‚     â”‚
  é‡‘é’±â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€ä½“åŠ›
    â”‚     â”‚     â”‚
    â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”
    â”‚     â”‚     â”‚
  è„‘åŠ›â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€ç¤¾ä¼šåå·®
    â”‚     â”‚     â”‚
    â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
          â”‚
        éå¸¸è§„æ€§
  ```

  #### æ™ºèƒ½ä»»åŠ¡æ‹†è§£

  ```typescript
  // lib/ai/ability.ts
  import { generateObject } from 'ai';
  import { z } from 'zod';

  const phaseSchema = z.object({
    phase: z.number(),
    duration: z.string().describe('å»ºè®®æŒç»­æ—¶é—´'),
    microHabit: z.string().describe('å¾®ä¹ æƒ¯å®šä¹‰'),
    successCriteria: z.string().describe('æˆåŠŸæ ‡å‡†'),
    difficultyScore: z.number().min(1).max(10),
  });

  const taskBreakdownSchema = z.object({
    analysis: z.string().describe('å½“å‰éš¾åº¦åˆ†æ'),
    phases: z.array(phaseSchema).describe('æ¸è¿›å¼é˜¶æ®µ'),
    tips: z.array(z.string()).describe('ç®€åŒ–å»ºè®®'),
  });

  export async function breakdownHabit(habit: HabitConfig) {
    const { object } = await generateObject({
      model: 'openai/gpt-4o',
      system: `ä½ æ˜¯ä¹ æƒ¯è®¾è®¡ä¸“å®¶ï¼Œç²¾é€š"2åˆ†é’Ÿè§„åˆ™"å’Œå¾®ä¹ æƒ¯ç†è®ºã€‚
  å°†ç”¨æˆ·çš„ç›®æ ‡ä¹ æƒ¯æ‹†è§£ä¸ºæ¸è¿›å¼é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µåº”è¯¥è¶³å¤Ÿç®€å•ï¼Œ
  è®©ç”¨æˆ·"ä¸å¯èƒ½å¤±è´¥"ã€‚`,
      prompt: `ç›®æ ‡ä¹ æƒ¯: ${habit.targetLevel}
  å½“å‰çŠ¶æ€: ${habit.currentLevel}
  è¯·è®¾è®¡æ¸è¿›å¼è®¡åˆ’`,
      schema: taskBreakdownSchema,
    });

    return object;
  }
  ```

  **æ‹†è§£ç¤ºä¾‹ï¼šæ¯å¤©è¿åŠ¨1å°æ—¶**

  ```
  é˜¶æ®µ1 (ç¬¬1-7å¤©): è¿åŠ¨è£…å¤‡å°±ä½
  â””â”€â”€ å¾®ä¹ æƒ¯ï¼šæ¯å¤©æŠŠè¿åŠ¨é‹æ”¾åœ¨é—¨å£ï¼ˆ30ç§’ï¼‰
  â””â”€â”€ æˆåŠŸæ ‡å‡†ï¼šé‹åœ¨é—¨å£å°±ç®—å®Œæˆ

  é˜¶æ®µ2 (ç¬¬2å‘¨): ç©¿ä¸Šè£…å¤‡
  â””â”€â”€ å¾®ä¹ æƒ¯ï¼šç©¿ä¸Šè¿åŠ¨æœå’Œé‹ï¼ˆ2åˆ†é’Ÿï¼‰
  â””â”€â”€ æˆåŠŸæ ‡å‡†ï¼šç©¿ä¸Šå°±ç®—å®Œæˆ

  é˜¶æ®µ3 (ç¬¬3å‘¨): èµ°å‡ºå®¶é—¨
  â””â”€â”€ å¾®ä¹ æƒ¯ï¼šç©¿å¥½è£…å¤‡èµ°å‡ºå®¶é—¨ï¼ˆ5åˆ†é’Ÿï¼‰
  â””â”€â”€ æˆåŠŸæ ‡å‡†ï¼šå‡ºé—¨å³å®Œæˆ

  é˜¶æ®µ4 (ç¬¬4-5å‘¨): 10åˆ†é’Ÿæ´»åŠ¨
  â””â”€â”€ ä»»åŠ¡ï¼šä»»æ„è¿åŠ¨10åˆ†é’Ÿ

  é˜¶æ®µ5 (ç¬¬6-8å‘¨): 30åˆ†é’Ÿè¿åŠ¨

  é˜¶æ®µ6 (ç¬¬9å‘¨+): 1å°æ—¶è¿åŠ¨ âœ“
  ```

  ### 4.5 æ¨¡å—äº”ï¼šåä¹ æƒ¯æˆ’é™¤ç³»ç»Ÿ

  #### ä¹ æƒ¯ç¯è·¯æ‰“æ–­

  ```
  ä¼ ç»Ÿä¹ æƒ¯ç¯è·¯:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  è§¦å‘ç‚¹  â”‚ â†â”€â”€ AIè¯†åˆ«è§¦å‘æ¨¡å¼
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  æ¸´æœ›   â”‚ â†â”€â”€ åˆ†ææ·±å±‚éœ€æ±‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  å“åº”   â”‚ â†â”€â”€ è®¾è®¡æ›¿ä»£è¡Œä¸º
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  å¥–åŠ±   â”‚ â†â”€â”€ é‡æ–°å®šä¹‰å¥–åŠ±
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

  #### è§¦å‘æ¨¡å¼åˆ†æ

  ```typescript
  // lib/ai/break-habit.ts
  import { generateObject } from 'ai';
  import { z } from 'zod';

  const triggerAnalysisSchema = z.object({
    patterns: z.array(z.object({
      type: z.enum(['TEMPORAL', 'CONTEXTUAL', 'EMOTIONAL', 'BEHAVIORAL']),
      description: z.string(),
      confidence: z.number().min(0).max(1),
      evidence: z.array(z.string()),
    })),
    deepNeed: z.string().describe('åä¹ æƒ¯æ»¡è¶³çš„æ·±å±‚éœ€æ±‚'),
    substituteBehaviors: z.array(z.string()).describe('æ›¿ä»£è¡Œä¸ºå»ºè®®'),
    environmentDesign: z.array(z.string()).describe('ç¯å¢ƒè®¾è®¡å»ºè®®'),
  });

  export async function analyzeTriggers(records: TriggerRecord[]) {
    const { object } = await generateObject({
      model: 'openai/gpt-4o',
      system: `ä½ æ˜¯è¡Œä¸ºåˆ†æä¸“å®¶ï¼Œæ“…é•¿è¯†åˆ«ä¹ æƒ¯è§¦å‘æ¨¡å¼ã€‚
  åˆ†ææ¡†æ¶ï¼š
  1. æ—¶é—´æ¨¡å¼ï¼šä»€ä¹ˆæ—¶é—´å®¹æ˜“è§¦å‘
  2. æƒ…å¢ƒæ¨¡å¼ï¼šä»€ä¹ˆåœºæ™¯å®¹æ˜“è§¦å‘
  3. æƒ…ç»ªæ¨¡å¼ï¼šä»€ä¹ˆæƒ…ç»ªçŠ¶æ€å®¹æ˜“è§¦å‘
  4. å‰åºè¡Œä¸ºï¼šè§¦å‘å‰é€šå¸¸åœ¨åšä»€ä¹ˆ`,
      prompt: `åˆ†æä»¥ä¸‹è§¦å‘è®°å½•ï¼š
  ${JSON.stringify(records, null, 2)}`,
      schema: triggerAnalysisSchema,
    });

    return object;
  }
  ```

  #### å¤å‘ç®¡ç†

  ```
  å¤å‘å“åº”æµç¨‹:

  ç”¨æˆ·è®°å½•å¤å‘ â†’ AIå…±æƒ…å“åº” â†’ å¼•å¯¼åˆ†æè§¦å‘ç‚¹ â†’ æ¨¡å¼åˆ†æ â†’ ç­–ç•¥è¿­ä»£ â†’ é‡å»ºä¿¡å¿ƒ
      â”‚              â”‚              â”‚            â”‚           â”‚          â”‚
      â†“              â†“              â†“            â†“           â†“          â†“
    "æˆ‘åˆæŠ½çƒŸäº†"   "å¤å‘æ˜¯æ­£å¸¸çš„ï¼Œ  "å½“æ—¶ä»€ä¹ˆæƒ…å†µï¼Ÿ   è¯†åˆ«æ–°æ¨¡å¼   è°ƒæ•´ç­–ç•¥    "ä½ å·²è¿ç»­Xå¤©
                  æˆ‘ä»¬æ¥çœ‹çœ‹å‘ç”Ÿ    ä½ çš„æ„Ÿå—æ˜¯ä»€ä¹ˆï¼Ÿ"             å»ºè®®       æˆåŠŸï¼Œè¿™æ¬¡åªæ˜¯
                  äº†ä»€ä¹ˆ"                                                ä¸€ä¸ªæ•°æ®ç‚¹"
  ```

  ### 4.6 æ¨¡å—å…­ï¼šAI æ•™ç»ƒå¯¹è¯

  #### å¯¹è¯åœºæ™¯

  | åœºæ™¯ç±»å‹ | æè¿° | ç¤ºä¾‹ |
  |---------|------|-----|
  | ä¹ æƒ¯è®¾å®š | åˆ›å»ºæ–°ä¹ æƒ¯ã€è°ƒæ•´ç›®æ ‡ | "æˆ‘æƒ³å…»æˆæ—©èµ·çš„ä¹ æƒ¯" |
  | æ—¥å¸¸ç­¾åˆ° | å®Œæˆç¡®è®¤ã€å›°éš¾åé¦ˆ | "ä»Šå¤©å®Œæˆäº†ï¼" |
  | å›°éš¾æ±‚åŠ© | é‡åˆ°éšœç¢ã€å¯»æ±‚å»ºè®® | "æœ€è¿‘æ€»æ˜¯åšæŒä¸ä¸‹å»" |
  | å¤ç›˜åˆ†æ | å‘¨æœŸå›é¡¾ã€ç­–ç•¥ä¼˜åŒ– | "å¸®æˆ‘åˆ†æä¸‹è¿™å‘¨çš„æƒ…å†µ" |

  #### å‰ç«¯å®ç°

  ```tsx
  // src/app/_components/habit-coach.tsx
  'use client';

  import { useChat } from '@ai-sdk/react';
  import { DefaultChatTransport } from 'ai';
  import { useState } from 'react';
  import { useSession } from 'next-auth/react';

  export function HabitCoach() {
    const [input, setInput] = useState('');
    const { data: session } = useSession();

    const { messages, sendMessage, isLoading } = useChat({
      transport: new DefaultChatTransport({
        api: '/api/chat',
      }),
    });

    if (!session) {
      return <div>è¯·å…ˆç™»å½•</div>;
    }

    return (
      <div className="flex flex-col w-full max-w-2xl mx-auto p-4">
        <div className="flex-1 space-y-4 mb-4">
          {messages.map(m => (
            <div key={m.id} className="whitespace-pre-wrap">
              <div className="font-bold">
                {m.role === 'user' ? 'ä½ ' : 'ä¹ æƒ¯æ•™ç»ƒ'}
              </div>
              {m.parts.map((part, index) => {
                if (part.type === 'text') {
                  return <p key={index}>{part.text}</p>;
                }
                if (part.type === 'tool-invocation' && part.toolName === 'createHabit') {
                  return (
                    <div key={index} className="bg-green-50 p-3 rounded-lg">
                      âœ… ä¹ æƒ¯åˆ›å»ºæˆåŠŸï¼
                    </div>
                  );
                }
                return null;
              })}
            </div>
          ))}
        </div>

        <form
          onSubmit={e => {
            e.preventDefault();
            sendMessage({ text: input });
            setInput('');
          }}
          className="flex gap-2"
        >
          <input
            value={input}
            onChange={e => setInput(e.target.value)}
            placeholder="å’Œä¹ æƒ¯æ•™ç»ƒèŠèŠ..."
            className="flex-1 p-3 border rounded-lg"
            disabled={isLoading}
          />
          <button
            type="submit"
            disabled={isLoading}
            className="px-6 py-3 bg-blue-600 text-white rounded-lg"
          >
            å‘é€
          </button>
        </form>
      </div>
    );
  }
  ```

  > **è¯´æ˜**: ä½¿ç”¨ `useSession` æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼ŒAI å¯¹è¯éœ€è¦ç”¨æˆ·å·²ç™»å½•ã€‚tRPC ç”¨äºä¹ æƒ¯æ•°æ®çš„ CRUD æ“ä½œã€‚

  #### ç³»ç»Ÿæç¤ºè¯

  ```typescript
  // lib/ai/prompts.ts
  export const HABIT_COACH_SYSTEM_PROMPT = `
  ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ä¹ æƒ¯æ•™ç»ƒï¼Œç²¾é€šç¦æ ¼è¡Œä¸ºæ¨¡å‹ï¼ˆFogg Behavior Modelï¼‰ã€‚

  ## æ ¸å¿ƒæ–¹æ³•è®º
  åŸºäº B=MAP å…¬å¼å¸®åŠ©ç”¨æˆ·ï¼š
  - M(åŠ¨æœº)ï¼šå¸®åŠ©ç”¨æˆ·å‘ç°å’Œç»´æŠ¤å†…åœ¨åŠ¨æœº
  - A(èƒ½åŠ›)ï¼šå¸®åŠ©ç”¨æˆ·é™ä½è¡ŒåŠ¨é—¨æ§›ï¼Œè®¾è®¡å¾®ä¹ æƒ¯
  - P(æç¤º)ï¼šå¸®åŠ©ç”¨æˆ·è®¾è®¡æœ‰æ•ˆçš„è§¦å‘æœºåˆ¶

  ## å¯¹è¯åŸåˆ™
  1. æ¯æ¬¡åªé—®ä¸€ä¸ªé—®é¢˜ï¼Œå¾ªåºæ¸è¿›
  2. å…ˆå€¾å¬ï¼Œç†è§£ç”¨æˆ·çœŸå®éœ€æ±‚
  3. ç»™å‡ºå¯æ‰§è¡Œçš„å°æ­¥éª¤ï¼Œè€Œéå¤§é“ç†
  4. ç”¨æé—®å¼•å¯¼ç”¨æˆ·è‡ªå·±å‘ç°ç­”æ¡ˆ
  5. åº†ç¥æ¯ä¸€ä¸ªå°è¿›æ­¥ï¼Œå¯¹å¤±è´¥ä¸è¯„åˆ¤

  ## é£æ ¼
  - æ¸©å’Œä½†ç›´æ¥
  - æ”¯æŒä½†ä¸è¿å°±
  - ä¸“ä¸šä½†ä¸è¯´æ•™
  - ç®€æ´ï¼Œæ¯æ¬¡å›å¤ä¸è¶…è¿‡100å­—
  `;
  ```

  ### 4.7 æ¨¡å—ä¸ƒï¼šæ•°æ®æ´å¯Ÿ

  #### æ´å¯Ÿç”Ÿæˆ

  ```typescript
  // lib/ai/insights.ts
  import { generateObject } from 'ai';
  import { z } from 'zod';

  const insightSchema = z.object({
    positive: z.object({
      title: z.string(),
      content: z.string().max(50),
    }).describe('æ­£å‘å¼ºåŒ–æ´å¯Ÿ'),
    pattern: z.object({
      title: z.string(),
      content: z.string().max(50),
    }).describe('æ¨¡å¼è¯†åˆ«æ´å¯Ÿ'),
    suggestion: z.object({
      title: z.string(),
      content: z.string().max(50),
      action: z.string().describe('å…·ä½“è¡ŒåŠ¨å»ºè®®'),
    }).describe('ä¼˜åŒ–å»ºè®®æ´å¯Ÿ'),
  });

  export async function generateInsights(data: HabitData) {
    const { object } = await generateObject({
      model: 'openai/gpt-4o',
      system: `ä½ æ˜¯æ•°æ®åˆ†æå¸ˆï¼Œæ“…é•¿ä»ä¹ æƒ¯æ•°æ®ä¸­å‘ç°æ¨¡å¼å’Œæ´å¯Ÿã€‚
  ç”Ÿæˆ3æ¡ç®€æ´æœ‰åŠ›çš„æ´å¯Ÿï¼Œæ¯æ¡ä¸è¶…è¿‡50å­—ã€‚`,
      prompt: `ä¹ æƒ¯æ•°æ®ï¼š
  ${JSON.stringify(data, null, 2)}`,
      schema: insightSchema,
    });

    return object;
  }
  ```

  #### æ´å¯Ÿç¤ºä¾‹

  ```
  âœ¨ æ­£å‘å¼ºåŒ–
  "å†¥æƒ³è¿ç»­7å¤©å…¨å‹¤ï¼è¿™æ˜¯ä½ åšæŒæœ€ä¹…çš„ä¹ æƒ¯ã€‚"

  ğŸ” æ¨¡å¼è¯†åˆ«
  "å‘¨å››è¿åŠ¨å®¹æ˜“ä¸­æ–­â€”â€”å’ŒåŠ ç­æ—¥é‡å ï¼Œè¿™ä¸æ˜¯æ„å¿—åŠ›é—®é¢˜ã€‚"

  ğŸ’¡ ä¼˜åŒ–å»ºè®®
  "è¯•è¯•æŠŠå‘¨å››çš„è¿åŠ¨æ”¹ä¸º5åˆ†é’Ÿæ‹‰ä¼¸ã€‚ä¿æŒè¿è´¯æ¯”å¼ºåº¦æ›´é‡è¦ã€‚"
  ```

  ### 4.8 æ¨¡å—å…«ï¼šå‘¨æœŸæŠ¥å‘Šç³»ç»Ÿ (v1.5)

  #### åŠŸèƒ½æ¦‚è¿°

  è‡ªåŠ¨ç”Ÿæˆå‘¨æŠ¥/æœˆæŠ¥ï¼Œå¸®åŠ©ç”¨æˆ·å›é¡¾ä¹ æƒ¯å…»æˆè¿›å±•ï¼Œæä¾›æ·±åº¦åˆ†æå’Œä¸‹é˜¶æ®µå»ºè®®ã€‚

  #### æŠ¥å‘Šç±»å‹

  | æŠ¥å‘Šç±»å‹ | ç”Ÿæˆå‘¨æœŸ | æ ¸å¿ƒå†…å®¹ |
  |---------|---------|---------|
  | å‘¨æŠ¥ | æ¯å‘¨æ—¥æ™š | æœ¬å‘¨å®Œæˆç‡ã€äº®ç‚¹ä¹ æƒ¯ã€æ”¹è¿›å»ºè®® |
  | æœˆæŠ¥ | æ¯æœˆæœ€åä¸€å¤© | æœˆåº¦è¶‹åŠ¿ã€é‡Œç¨‹ç¢‘å›é¡¾ã€ä¸‹æœˆè§„åˆ’ |
  | é˜¶æ®µæŠ¥å‘Š | ä¹ æƒ¯è¾¾åˆ°21/66å¤© | é˜¶æ®µæˆå°±ã€ä¹ æƒ¯å¼ºåº¦è¯„ä¼°ã€å‡çº§å»ºè®® |

  #### æŠ¥å‘Šç»“æ„è®¾è®¡

  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                    ğŸ“Š ä¹ æƒ¯å‘¨æŠ¥                               â”‚
  â”‚                  2025.11.20 - 11.27                         â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ“ˆ æ€»ä½“æ¦‚è§ˆ                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
  â”‚  â”‚  æœ¬å‘¨å®Œæˆç‡: 85% (â†‘12%)  â”‚  æ´»è·ƒä¹ æƒ¯: 4ä¸ª           â”‚   â”‚
  â”‚  â”‚  æœ€é•¿è¿ç»­: 14å¤©          â”‚  ç´¯è®¡æ‰“å¡: 24æ¬¡          â”‚   â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ† æœ¬å‘¨äº®ç‚¹                                                 â”‚
  â”‚  â€¢ æ—©èµ·ä¹ æƒ¯è¿ç»­7å¤©å…¨å‹¤ï¼Œå·²è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼                      â”‚
  â”‚  â€¢ é˜…è¯»æ—¶é—´è¾ƒä¸Šå‘¨å¢åŠ 40åˆ†é’Ÿ                                  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ” æ¨¡å¼å‘ç°                                                 â”‚
  â”‚  â€¢ å‘¨ä¸‰å®Œæˆç‡æœ€ä½(60%)ï¼Œå¯èƒ½ä¸å‘¨ä¸­ç–²åŠ³ç›¸å…³                   â”‚
  â”‚  â€¢ æ—©æ™¨ä¹ æƒ¯å®Œæˆç‡(92%)æ˜¾è‘—é«˜äºæ™šé—´(68%)                     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ’¡ ä¸‹å‘¨å»ºè®®                                                 â”‚
  â”‚  â€¢ è€ƒè™‘å°†"è¿åŠ¨"ä»æ™šé—´è°ƒæ•´åˆ°æ—©æ™¨                              â”‚
  â”‚  â€¢ å‘¨ä¸‰å¯å°è¯•æ‰§è¡Œç®€åŒ–ç‰ˆå¾®ä¹ æƒ¯                                 â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚  ğŸ¯ ä¸‹å‘¨ç›®æ ‡                                                 â”‚
  â”‚  â–¡ æ—©èµ·è¿ç»­è¾¾åˆ°14å¤©                                          â”‚
  â”‚  â–¡ è¿åŠ¨å®Œæˆç‡æå‡è‡³80%                                       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

  #### æŠ€æœ¯å®ç°

  ```typescript
  // src/server/api/routers/report.ts
  import { createTRPCRouter, protectedProcedure } from '@/server/api/trpc';
  import { generateObject } from 'ai';
  import { z } from 'zod';

  const weeklyReportSchema = z.object({
    summary: z.object({
      completionRate: z.number(),
      rateChange: z.number(),
      activeHabits: z.number(),
      longestStreak: z.number(),
      totalCheckins: z.number(),
    }),
    highlights: z.array(z.object({
      habitName: z.string(),
      achievement: z.string(),
      emoji: z.string(),
    })),
    patterns: z.array(z.object({
      finding: z.string(),
      implication: z.string(),
      confidence: z.number().min(0).max(1),
    })),
    suggestions: z.array(z.object({
      category: z.enum(['TIMING', 'DIFFICULTY', 'MOTIVATION', 'TRIGGER']),
      suggestion: z.string(),
      expectedImpact: z.string(),
    })),
    nextWeekGoals: z.array(z.object({
      goal: z.string(),
      habitId: z.string().optional(),
      measurable: z.string(),
    })),
  });

  export const reportRouter = createTRPCRouter({
    // è·å–å‘¨æŠ¥
    getWeeklyReport: protectedProcedure
      .input(z.object({
        weekStart: z.date(),
      }))
      .query(async ({ ctx, input }) => {
        // è·å–æœ¬å‘¨æ•°æ®
        const weekData = await ctx.db.habitLog.findMany({
          where: {
            userId: ctx.session.user.id,
            loggedAt: {
              gte: input.weekStart,
              lt: new Date(input.weekStart.getTime() + 7 * 24 * 60 * 60 * 1000),
            },
          },
          include: { habit: true },
        });

        const habits = await ctx.db.habit.findMany({
          where: { userId: ctx.session.user.id, status: 'ACTIVE' },
        });

        // AI ç”ŸæˆæŠ¥å‘Š
        const { object: report } = await generateObject({
          model: 'openai/gpt-4o',
          system: `ä½ æ˜¯ä¹ æƒ¯æ•°æ®åˆ†æå¸ˆï¼Œæ“…é•¿ä»æ•°æ®ä¸­å‘ç°æœ‰ä»·å€¼çš„æ´å¯Ÿã€‚
ç”Ÿæˆå‘¨æŠ¥æ—¶ï¼š
1. çªå‡ºæ­£å‘æˆå°±ï¼Œç»™äºˆè‚¯å®š
2. å‘ç°æ•°æ®ä¸­çš„è§„å¾‹å’Œæ¨¡å¼
3. æä¾›å…·ä½“å¯è¡Œçš„æ”¹è¿›å»ºè®®
4. è®¾å®šåˆç†çš„ä¸‹å‘¨ç›®æ ‡`,
          prompt: `åŸºäºä»¥ä¸‹æ•°æ®ç”Ÿæˆå‘¨æŠ¥ï¼š
ä¹ æƒ¯åˆ—è¡¨: ${JSON.stringify(habits)}
æœ¬å‘¨è®°å½•: ${JSON.stringify(weekData)}`,
          schema: weeklyReportSchema,
        });

        return report;
      }),

    // è·å–æœˆæŠ¥
    getMonthlyReport: protectedProcedure
      .input(z.object({
        year: z.number(),
        month: z.number(),
      }))
      .query(async ({ ctx, input }) => {
        // å®ç°ç±»ä¼¼ï¼Œèšåˆæœˆåº¦æ•°æ®
        // ...
      }),

    // ç”Ÿæˆé˜¶æ®µæ€§é‡Œç¨‹ç¢‘æŠ¥å‘Š
    getMilestoneReport: protectedProcedure
      .input(z.object({
        habitId: z.string(),
        milestone: z.enum(['DAY_7', 'DAY_21', 'DAY_66']),
      }))
      .query(async ({ ctx, input }) => {
        // å®ç°é‡Œç¨‹ç¢‘æŠ¥å‘Šç”Ÿæˆ
        // ...
      }),
  });
  ```

  #### æŠ¥å‘Šæ¨é€ç­–ç•¥

  ```typescript
  // lib/jobs/report-scheduler.ts
  // ä½¿ç”¨ Vercel Cron Jobs å®šæ—¶ç”ŸæˆæŠ¥å‘Š

  // vercel.json
  {
    "crons": [
      {
        "path": "/api/cron/weekly-report",
        "schedule": "0 20 * * 0"  // æ¯å‘¨æ—¥æ™š8ç‚¹
      },
      {
        "path": "/api/cron/monthly-report",
        "schedule": "0 20 L * *"  // æ¯æœˆæœ€åä¸€å¤©æ™š8ç‚¹
      }
    ]
  }
  ```

  ### 4.9 æ¨¡å—ä¹ï¼šè¿›é˜¶åˆ†æç³»ç»Ÿ (v1.5)

  #### åŠŸèƒ½æ¦‚è¿°

  æä¾›æ·±åº¦æ•°æ®åˆ†æèƒ½åŠ›ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£ä¹ æƒ¯å…»æˆçš„æ·±å±‚è§„å¾‹ã€‚

  #### åˆ†æç»´åº¦

  ```
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                      è¿›é˜¶åˆ†æä»ªè¡¨æ¿                              â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚                                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚   æ—¶é—´çƒ­åŠ›å›¾     â”‚  â”‚   æƒ…ç»ªå…³è”åˆ†æ   â”‚  â”‚   éš¾åº¦æ›²çº¿å›¾     â”‚ â”‚
  â”‚  â”‚   (å®Œæˆæ—¶æ®µ)     â”‚  â”‚   (å¿ƒæƒ…å˜åŒ–)     â”‚  â”‚   (ä¸»è§‚æ„Ÿå—)     â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚                                                                 â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
  â”‚  â”‚   ä¹ æƒ¯å…³è”çŸ©é˜µ   â”‚  â”‚   è¿ç»­æ€§åˆ†æ     â”‚  â”‚   é¢„æµ‹æ¨¡å‹       â”‚ â”‚
  â”‚  â”‚   (ç›¸äº’å½±å“)     â”‚  â”‚   (ä¸­æ–­é£é™©)     â”‚  â”‚   (æˆåŠŸæ¦‚ç‡)     â”‚ â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
  â”‚                                                                 â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ```

  #### æ ¸å¿ƒåˆ†æåŠŸèƒ½

  **1. æ—¶é—´çƒ­åŠ›å›¾åˆ†æ**

  ```typescript
  // lib/ai/analytics.ts
  const timeHeatmapSchema = z.object({
    heatmap: z.array(z.object({
      dayOfWeek: z.number().min(0).max(6),
      hourOfDay: z.number().min(0).max(23),
      completionRate: z.number(),
      avgDuration: z.number().optional(),
    })),
    insights: z.array(z.string()),
    optimalWindows: z.array(z.object({
      dayOfWeek: z.number(),
      startHour: z.number(),
      endHour: z.number(),
      reason: z.string(),
    })),
  });

  export async function analyzeTimePatterns(logs: HabitLog[]) {
    const { object } = await generateObject({
      model: 'openai/gpt-4o',
      system: `åˆ†æä¹ æƒ¯å®Œæˆçš„æ—¶é—´æ¨¡å¼ï¼Œæ‰¾å‡ºæœ€ä½³æ‰§è¡Œæ—¶é—´çª—å£ã€‚`,
      prompt: `ä¹ æƒ¯è®°å½•æ•°æ®: ${JSON.stringify(logs)}`,
      schema: timeHeatmapSchema,
    });
    return object;
  }
  ```

  **2. æƒ…ç»ªå…³è”åˆ†æ**

  ```typescript
  const moodCorrelationSchema = z.object({
    beforeAfterCorrelation: z.object({
      averageMoodBefore: z.number(),
      averageMoodAfter: z.number(),
      moodLift: z.number(),
      significance: z.enum(['HIGH', 'MEDIUM', 'LOW']),
    }),
    moodTriggers: z.array(z.object({
      trigger: z.string(),
      impactOnCompletion: z.number(), // -1 åˆ° 1
      frequency: z.number(),
    })),
    recommendations: z.array(z.string()),
  });

  export async function analyzeMoodCorrelation(logs: HabitLog[]) {
    const { object } = await generateObject({
      model: 'openai/gpt-4o',
      system: `åˆ†ææƒ…ç»ªä¸ä¹ æƒ¯å®Œæˆçš„å…³è”æ€§ã€‚
é‡ç‚¹å…³æ³¨ï¼š
1. ä¹ æƒ¯å‰åæƒ…ç»ªå˜åŒ–
2. ä½æƒ…ç»ªçŠ¶æ€ä¸‹çš„å®Œæˆç­–ç•¥
3. ä¹ æƒ¯å¯¹æƒ…ç»ªçš„æ­£å‘å½±å“`,
      prompt: `è®°å½•æ•°æ®: ${JSON.stringify(logs)}`,
      schema: moodCorrelationSchema,
    });
    return object;
  }
  ```

  **3. ä¹ æƒ¯å…³è”çŸ©é˜µ**

  ```typescript
  const habitCorrelationSchema = z.object({
    correlations: z.array(z.object({
      habit1Id: z.string(),
      habit2Id: z.string(),
      correlationScore: z.number().min(-1).max(1),
      relationship: z.enum(['POSITIVE', 'NEGATIVE', 'NEUTRAL']),
      insight: z.string(),
    })),
    clusters: z.array(z.object({
      name: z.string(),
      habitIds: z.array(z.string()),
      description: z.string(),
    })),
    suggestions: z.array(z.object({
      type: z.enum(['STACK', 'SEPARATE', 'SEQUENCE']),
      habits: z.array(z.string()),
      reason: z.string(),
    })),
  });

  export async function analyzeHabitCorrelations(
    habits: Habit[],
    logs: HabitLog[]
  ) {
    const { object } = await generateObject({
      model: 'openai/gpt-4o',
      system: `åˆ†æå¤šä¸ªä¹ æƒ¯ä¹‹é—´çš„å…³è”æ€§ã€‚
å¯»æ‰¾ï¼š
1. æ­£ç›¸å…³ä¹ æƒ¯ï¼ˆä¸€èµ·å®Œæˆï¼‰
2. è´Ÿç›¸å…³ä¹ æƒ¯ï¼ˆäº’ç›¸æ’æ–¥ï¼‰
3. ä¹ æƒ¯å †å çš„æœºä¼š`,
      prompt: `ä¹ æƒ¯: ${JSON.stringify(habits)}
è®°å½•: ${JSON.stringify(logs)}`,
      schema: habitCorrelationSchema,
    });
    return object;
  }
  ```

  **4. ä¸­æ–­é£é™©é¢„æµ‹**

  ```typescript
  const breakRiskSchema = z.object({
    overallRisk: z.enum(['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']),
    riskScore: z.number().min(0).max(100),
    riskFactors: z.array(z.object({
      factor: z.string(),
      weight: z.number(),
      currentStatus: z.string(),
    })),
    warningSignals: z.array(z.object({
      signal: z.string(),
      detected: z.boolean(),
      lastOccurrence: z.string().optional(),
    })),
    preventiveActions: z.array(z.object({
      action: z.string(),
      priority: z.enum(['HIGH', 'MEDIUM', 'LOW']),
      expectedImpact: z.string(),
    })),
  });

  export async function predictBreakRisk(
    habit: Habit,
    recentLogs: HabitLog[]
  ) {
    const { object } = await generateObject({
      model: 'openai/gpt-4o',
      system: `é¢„æµ‹ä¹ æƒ¯ä¸­æ–­é£é™©ã€‚
é£é™©ä¿¡å·åŒ…æ‹¬ï¼š
1. å®Œæˆç‡ä¸‹é™è¶‹åŠ¿
2. å»¶è¿Ÿå®Œæˆå¢åŠ 
3. ä¸»è§‚éš¾åº¦è¯„åˆ†ä¸Šå‡
4. æƒ…ç»ªåˆ†æ•°ä¸‹é™
5. è·³è¿‡å¤©æ•°å¢åŠ `,
      prompt: `ä¹ æƒ¯: ${JSON.stringify(habit)}
è¿‘æœŸè®°å½•: ${JSON.stringify(recentLogs)}`,
      schema: breakRiskSchema,
    });
    return object;
  }
  ```

  #### å¯è§†åŒ–ç»„ä»¶

  ```tsx
  // src/app/_components/analytics/time-heatmap.tsx
  'use client';

  import {
    ResponsiveContainer,
    ScatterChart,
    Scatter,
    XAxis,
    YAxis,
    Tooltip,
    Cell
  } from 'recharts';
  import { api } from '@/trpc/react';

  export function TimeHeatmap({ habitId }: { habitId?: string }) {
    const { data } = api.analytics.getTimeHeatmap.useQuery({ habitId });

    const getColor = (rate: number) => {
      if (rate >= 0.8) return '#22c55e'; // green
      if (rate >= 0.6) return '#84cc16'; // lime
      if (rate >= 0.4) return '#eab308'; // yellow
      if (rate >= 0.2) return '#f97316'; // orange
      return '#ef4444'; // red
    };

    return (
      <div className="h-64">
        <ResponsiveContainer>
          <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 40 }}>
            <XAxis
              dataKey="hourOfDay"
              name="å°æ—¶"
              domain={[0, 23]}
              tickFormatter={(h) => `${h}:00`}
            />
            <YAxis
              dataKey="dayOfWeek"
              name="æ˜ŸæœŸ"
              domain={[0, 6]}
              tickFormatter={(d) => ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][d]}
            />
            <Tooltip
              formatter={(value, name) => [
                name === 'completionRate' ? `${(value * 100).toFixed(0)}%` : value,
                name === 'completionRate' ? 'å®Œæˆç‡' : name
              ]}
            />
            <Scatter data={data?.heatmap} fill="#8884d8">
              {data?.heatmap.map((entry, index) => (
                <Cell key={index} fill={getColor(entry.completionRate)} />
              ))}
            </Scatter>
          </ScatterChart>
        </ResponsiveContainer>
      </div>
    );
  }
  ```

  #### åˆ†æ tRPC Router

  ```typescript
  // src/server/api/routers/analytics.ts
  import { createTRPCRouter, protectedProcedure } from '@/server/api/trpc';
  import { z } from 'zod';
  import {
    analyzeTimePatterns,
    analyzeMoodCorrelation,
    analyzeHabitCorrelations,
    predictBreakRisk
  } from '@/lib/ai/analytics';

  export const analyticsRouter = createTRPCRouter({
    getTimeHeatmap: protectedProcedure
      .input(z.object({ habitId: z.string().optional() }))
      .query(async ({ ctx, input }) => {
        const logs = await ctx.db.habitLog.findMany({
          where: {
            userId: ctx.session.user.id,
            ...(input.habitId && { habitId: input.habitId }),
          },
          orderBy: { loggedAt: 'desc' },
          take: 90, // æœ€è¿‘90å¤©
        });
        return analyzeTimePatterns(logs);
      }),

    getMoodAnalysis: protectedProcedure
      .input(z.object({ habitId: z.string() }))
      .query(async ({ ctx, input }) => {
        const logs = await ctx.db.habitLog.findMany({
          where: {
            userId: ctx.session.user.id,
            habitId: input.habitId,
            moodBefore: { not: null },
          },
        });
        return analyzeMoodCorrelation(logs);
      }),

    getHabitCorrelations: protectedProcedure
      .query(async ({ ctx }) => {
        const habits = await ctx.db.habit.findMany({
          where: { userId: ctx.session.user.id, status: 'ACTIVE' },
        });
        const logs = await ctx.db.habitLog.findMany({
          where: { userId: ctx.session.user.id },
          orderBy: { loggedAt: 'desc' },
          take: 180, // æœ€è¿‘180å¤©
        });
        return analyzeHabitCorrelations(habits, logs);
      }),

    getBreakRiskPrediction: protectedProcedure
      .input(z.object({ habitId: z.string() }))
      .query(async ({ ctx, input }) => {
        const habit = await ctx.db.habit.findUnique({
          where: { id: input.habitId },
        });
        const logs = await ctx.db.habitLog.findMany({
          where: { habitId: input.habitId },
          orderBy: { loggedAt: 'desc' },
          take: 14, // æœ€è¿‘14å¤©
        });
        return predictBreakRisk(habit!, logs);
      }),
  });
  ```

  ---

  ## 5. AI SDK æŠ€æœ¯å®ç°ï¼ˆv6 æœ€æ–°ç‰ˆï¼‰

  ### 5.1 Vercel AI Gateway æ¨¡å‹é…ç½®

  ```typescript
  // ç›´æ¥åœ¨è°ƒç”¨æ—¶æŒ‡å®šæ¨¡å‹ï¼Œæ— éœ€å•ç‹¬é…ç½®æ–‡ä»¶
  // æ”¯æŒçš„æ¨¡å‹æ ¼å¼ï¼šprovider/model-name

  // streamText
  streamText({ model: 'openai/gpt-4o', ... });

  // generateObject
  generateObject({ model: 'openai/gpt-4o', ... });

  // generateText
  generateText({ model: 'anthropic/claude-sonnet-4-20250514', ... });
  ```

  ### 5.2 ç¯å¢ƒå˜é‡é…ç½®

  ```env
  # .env.local

  # Vercel AI Gatewayï¼ˆç»Ÿä¸€ API Keyï¼Œè®¿é—®å¤šä¸ªæä¾›å•†ï¼‰
  AI_GATEWAY_API_KEY=your-api-key

  # æ•°æ®åº“ (Prisma)
  DATABASE_URL=postgresql://user:password@localhost:5432/micro_gravity

  # NextAuth.js v5
  AUTH_SECRET=your-auth-secret-here
  AUTH_DISCORD_ID=your-discord-client-id
  AUTH_DISCORD_SECRET=your-discord-client-secret
  ```

  ### 5.3 æ ¸å¿ƒ API ä½¿ç”¨æ¨¡å¼

  #### streamText - å¯¹è¯æµå¼å“åº”

  ```typescript
  import { streamText, convertToModelMessages, UIMessage } from 'ai';

  export async function POST(req: Request) {
    const { messages }: { messages: UIMessage[] } = await req.json();

    const result = streamText({
      model: 'openai/gpt-4o',
      system: SYSTEM_PROMPT,
      messages: convertToModelMessages(messages),
    });

    return result.toUIMessageStreamResponse();
  }
  ```

  #### generateObject - ç»“æ„åŒ–è¾“å‡º

  ```typescript
  import { generateObject } from 'ai';
  import { z } from 'zod';

  const schema = z.object({
    field1: z.string(),
    field2: z.number(),
  });

  const { object } = await generateObject({
    model: 'openai/gpt-4o',
    system: 'System prompt here',
    prompt: 'User prompt here',
    schema: schema,
  });
  ```

  #### tool - å·¥å…·å®šä¹‰

  ```typescript
  import { tool } from 'ai';
  import { z } from 'zod';

  const myTool = tool({
    description: 'å·¥å…·æè¿°',
    inputSchema: z.object({
      param1: z.string().describe('å‚æ•°æè¿°'),
    }),
    execute: async ({ param1 }) => {
      // æ‰§è¡Œé€»è¾‘
      return result;
    },
  });
  ```

  ### 5.4 å¤šæ­¥éª¤è°ƒç”¨ï¼ˆAgent æ¨¡å¼ï¼‰

  ```typescript
  import { streamText, stepCountIs, convertToModelMessages } from 'ai';

  const result = streamText({
    model: 'openai/gpt-4o',
    messages: convertToModelMessages(messages),
    tools: { /* ... */ },
    stopWhen: stepCountIs(5), // æœ€å¤š5æ­¥
  });
  ```

  ### 5.5 å‰ç«¯ useChat Hook

  ```typescript
  'use client';
  import { useChat } from '@ai-sdk/react';
  import { DefaultChatTransport } from 'ai';
  import { useState } from 'react';

  export function ChatComponent() {
    const [input, setInput] = useState('');
    const { messages, sendMessage, isLoading } = useChat({
      transport: new DefaultChatTransport({
        api: '/api/chat',
      }),
    });

    // å‘é€æ¶ˆæ¯
    const handleSubmit = () => {
      sendMessage({ text: input });
      setInput('');
    };

    // æ¸²æŸ“æ¶ˆæ¯ï¼ˆä½¿ç”¨ partsï¼‰
    return (
      <div>
        {messages.map(m => (
          <div key={m.id}>
            {m.parts.map((part, i) => {
              if (part.type === 'text') return <p key={i}>{part.text}</p>;
              if (part.type === 'tool-invocation') {
                return <div key={i}>å·¥å…·è°ƒç”¨: {part.toolName}</div>;
              }
              return null;
            })}
          </div>
        ))}
      </div>
    );
  }
  ```

  ---

  ## 6. æ•°æ®åº“è®¾è®¡

  ### 6.1 Schema å®šä¹‰ï¼ˆPrisma ORMï¼‰

  ```prisma
  // prisma/schema.prisma

  generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
  }

  datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
  }

  // NextAuth.js æ‰€éœ€æ¨¡å‹
  model Account {
    id                       String  @id @default(cuid())
    userId                   String
    type                     String
    provider                 String
    providerAccountId        String
    refresh_token            String?
    access_token             String?
    expires_at               Int?
    token_type               String?
    scope                    String?
    id_token                 String?
    session_state            String?
    user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    @@unique([provider, providerAccountId])
  }

  model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  }

  model User {
    id                 String    @id @default(cuid())
    name               String?
    email              String?   @unique
    emailVerified      DateTime?
    image              String?
    motivationProfile  Json?     // åŠ¨æœºç”»åƒ
    preferences        Json?
    accounts           Account[]
    sessions           Session[]
    habits             Habit[]
    habitLogs          HabitLog[]
    conversations      Conversation[]
    // v1.5 æ–°å¢
    reports            Report[]
    milestones         Milestone[]
    analyticsSnapshots AnalyticsSnapshot[]
    createdAt          DateTime  @default(now())
    updatedAt          DateTime  @updatedAt
  }

  model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime
    @@unique([identifier, token])
  }

  // ä¹ æƒ¯ç±»å‹æšä¸¾
  enum HabitType {
    BUILD  // å…»æˆ
    BREAK  // æˆ’é™¤
  }

  enum HabitStatus {
    ACTIVE
    PAUSED
    COMPLETED
    ARCHIVED
  }

  // å¯¹è¯ç±»å‹æšä¸¾
  enum ConversationType {
    SETUP      // ä¹ æƒ¯è®¾å®š
    CHECKIN    // æ—¥å¸¸ç­¾åˆ°
    HELP       // å›°éš¾æ±‚åŠ©
    REVIEW     // å¤ç›˜åˆ†æ
  }

  // åˆ†æç±»å‹æšä¸¾
  enum AnalysisType {
    TIME_HEATMAP   // æ—¶é—´çƒ­åŠ›å›¾
    MOOD           // æƒ…ç»ªåˆ†æ
    CORRELATION    // ä¹ æƒ¯å…³è”
    RISK           // ä¸­æ–­é£é™©
  }

  model Habit {
    id           String      @id @default(cuid())
    userId       String
    user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
    type         HabitType
    name         String      @db.VarChar(100)
    description  String?
    category     String?     @db.VarChar(50)

    // MAPæ¨¡å‹æ•°æ® (ç¦æ ¼è¡Œä¸ºæ¨¡å‹) - å‚è§ 6.2 ç±»å‹å®šä¹‰
    motivation   Json        // Motivation: { primaryType, deepReason, visionStatement, painPoints?, motivationScore }
    ability      Json        // Ability: { currentLevel, targetLevel, microHabit, difficultyScore, barriers?, simplificationTips? }
    prompt       Json        // Prompt: { anchorHabit, triggerType, preferredTime, contextCues?, reminderStyle? }

    // è¿›åº¦è¿½è¸ª
    currentPhase Int         @default(1)
    phases       Json?       // PhaseConfig[]: æ¸è¿›å¼é˜¶æ®µé…ç½®

    status       HabitStatus @default(ACTIVE)
    logs         HabitLog[]
    conversations Conversation[]
    // v1.5 æ–°å¢
    milestones   Milestone[]
    createdAt    DateTime    @default(now())
    updatedAt    DateTime    @updatedAt

    @@index([userId])
  }

  model HabitLog {
    id               String    @id @default(cuid())
    habitId          String
    habit            Habit     @relation(fields: [habitId], references: [id], onDelete: Cascade)
    userId           String
    user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    loggedAt         DateTime  @db.Date
    completed        Boolean

    completionTime   DateTime?
    durationMinutes  Int?
    difficultyRating Int?      // 1-5
    moodBefore       Int?      // 1-5
    moodAfter        Int?      // 1-5
    notes            String?
    triggerContext   Json?     // TriggerRecord: æˆ’é™¤åœºæ™¯è®°å½• (ä»… BREAK ç±»å‹ä¹ æƒ¯)

    createdAt        DateTime  @default(now())

    @@index([habitId])
    @@index([userId])
    @@index([loggedAt])
    @@unique([habitId, loggedAt]) // é˜²æ­¢åŒä¸€å¤©é‡å¤æ‰“å¡
  }

  model Conversation {
    id               String            @id @default(cuid())
    userId           String
    user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    habitId          String?
    habit            Habit?            @relation(fields: [habitId], references: [id], onDelete: SetNull)
    conversationType ConversationType? // ä½¿ç”¨æšä¸¾
    messages         Json              // AIå¯¹è¯å†å²
    createdAt        DateTime          @default(now())
    updatedAt        DateTime          @updatedAt

    @@index([userId])
    @@index([habitId])
  }

  // ============ v1.5 æ–°å¢æ¨¡å‹ ============

  // æŠ¥å‘Šç±»å‹æšä¸¾
  enum ReportType {
    WEEKLY      // å‘¨æŠ¥
    MONTHLY     // æœˆæŠ¥
    MILESTONE   // é‡Œç¨‹ç¢‘æŠ¥å‘Š
  }

  // é‡Œç¨‹ç¢‘ç±»å‹
  enum MilestoneType {
    DAY_7       // 7å¤©æˆå°±
    DAY_21      // 21å¤©ä¹ æƒ¯åˆæ­¥å½¢æˆ
    DAY_66      // 66å¤©ä¹ æƒ¯å·©å›º
    DAY_100     // 100å¤©é‡Œç¨‹ç¢‘
    CUSTOM      // è‡ªå®šä¹‰é‡Œç¨‹ç¢‘
  }

  model Report {
    id           String       @id @default(cuid())
    userId       String
    user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    type         ReportType

    // æŠ¥å‘Šå‘¨æœŸ
    periodStart  DateTime
    periodEnd    DateTime

    // AI ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹
    summary      Json         // { completionRate, rateChange, activeHabits, ... }
    highlights   Json         // äº®ç‚¹æ•°ç»„
    patterns     Json         // æ¨¡å¼å‘ç°æ•°ç»„
    suggestions  Json         // å»ºè®®æ•°ç»„
    goals        Json?        // ä¸‹æœŸç›®æ ‡

    // å…ƒæ•°æ®
    generatedAt  DateTime     @default(now())
    isRead       Boolean      @default(false)

    @@index([userId])
    @@index([type])
    @@index([periodStart])
    @@unique([userId, type, periodStart]) // é˜²æ­¢åŒå‘¨æœŸé‡å¤ç”Ÿæˆ
  }

  model Milestone {
    id           String        @id @default(cuid())
    habitId      String
    habit        Habit         @relation(fields: [habitId], references: [id], onDelete: Cascade)
    userId       String
    user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
    type         MilestoneType

    // è¾¾æˆä¿¡æ¯
    achievedAt   DateTime
    streakDays   Int           // è¾¾æˆæ—¶çš„è¿ç»­å¤©æ•°

    // AI ç”Ÿæˆçš„é‡Œç¨‹ç¢‘æŠ¥å‘Š
    celebration  String        // åº†ç¥æ–‡æ¡ˆ
    reflection   Json          // å›é¡¾åˆ†æ
    nextPhase    Json?         // ä¸‹é˜¶æ®µå»ºè®®

    // åˆ†äº«ç›¸å…³
    isShared     Boolean       @default(false)
    shareToken   String?       @unique

    createdAt    DateTime      @default(now())

    @@index([habitId])
    @@index([userId])
    @@index([type])
    @@unique([habitId, type]) // åŒä¸€ä¹ æƒ¯åŒä¸€é‡Œç¨‹ç¢‘ç±»å‹åªèƒ½è¾¾æˆä¸€æ¬¡
  }

  // åˆ†æå¿«ç…§ - ç¼“å­˜ AI åˆ†æç»“æœ
  model AnalyticsSnapshot {
    id           String       @id @default(cuid())
    userId       String
    user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    habitId      String?      // å¯é€‰ï¼Œnull è¡¨ç¤ºå…¨å±€åˆ†æ

    // åˆ†æç±»å‹
    analysisType AnalysisType // ä½¿ç”¨æšä¸¾

    // ç¼“å­˜çš„åˆ†æç»“æœ
    data         Json

    // æœ‰æ•ˆæœŸ
    generatedAt  DateTime     @default(now())
    expiresAt    DateTime

    @@index([userId])
    @@index([analysisType])
    @@unique([userId, habitId, analysisType])
  }
  ```

  > **v1.5 æ•°æ®æ¨¡å‹è¯´æ˜**:
  > - `Report`: å­˜å‚¨ AI ç”Ÿæˆçš„å‘¨æŠ¥/æœˆæŠ¥ï¼Œæ”¯æŒå†å²æŸ¥çœ‹
  > - `Milestone`: è®°å½•ä¹ æƒ¯é‡Œç¨‹ç¢‘æˆå°±ï¼Œæ”¯æŒç¤¾äº¤åˆ†äº«
  > - `AnalyticsSnapshot`: ç¼“å­˜ AI åˆ†æç»“æœï¼Œé¿å…é‡å¤è®¡ç®—

  ### 6.2 ç±»å‹å®šä¹‰

  ```typescript
  // lib/types.ts
  import { z } from 'zod';

  // åŠ¨æœºé…ç½®
  export const motivationSchema = z.object({
    primaryType: z.enum(['PLEASURE', 'HOPE', 'SOCIAL']),
    deepReason: z.string(),
    visionStatement: z.string(),
    painPoints: z.array(z.string()).optional(),
    motivationScore: z.number().min(1).max(10),
  });

  // èƒ½åŠ›é…ç½®
  export const abilitySchema = z.object({
    currentLevel: z.string(),
    targetLevel: z.string(),
    microHabit: z.string(),
    difficultyScore: z.number().min(1).max(10),
    barriers: z.array(z.string()).optional(),
    simplificationTips: z.array(z.string()).optional(),
  });

  // æç¤ºé…ç½®
  export const promptSchema = z.object({
    anchorHabit: z.string(),
    triggerType: z.enum(['SIGNAL', 'FACILITATOR', 'SPARK']),
    preferredTime: z.string(),
    contextCues: z.array(z.string()).optional(),
    reminderStyle: z.enum(['GENTLE', 'FIRM', 'PLAYFUL']).optional(),
  });

  // å®Œæ•´ä¹ æƒ¯é…ç½®
  export const habitConfigSchema = z.object({
    name: z.string(),
    type: z.enum(['BUILD', 'BREAK']),
    category: z.string().optional(),
    motivation: motivationSchema,
    ability: abilitySchema,
    prompt: promptSchema,
  });

  export type HabitConfig = z.infer<typeof habitConfigSchema>;
  export type Motivation = z.infer<typeof motivationSchema>;
  export type Ability = z.infer<typeof abilitySchema>;
  export type Prompt = z.infer<typeof promptSchema>;

  // ============ ä¸Šä¸‹æ–‡ç±»å‹å®šä¹‰ ============

  // æé†’ç”Ÿæˆä¸Šä¸‹æ–‡
  export const reminderContextSchema = z.object({
    habitId: z.string(),
    habitName: z.string(),
    habitType: z.enum(['BUILD', 'BREAK']),
    motivationType: z.enum(['PLEASURE', 'HOPE', 'SOCIAL']),
    motivationLevel: z.number().min(1).max(10),
    streakDays: z.number(),
    recentRate: z.number().min(0).max(100), // æœ€è¿‘7å¤©å®Œæˆç‡
    lastCompletedAt: z.date().optional(),
    currentPhase: z.number(),
  });
  export type ReminderContext = z.infer<typeof reminderContextSchema>;

  // åŠ¨æœºæ¿€åŠ±ä¸Šä¸‹æ–‡
  export const motivationContextSchema = z.object({
    habitId: z.string(),
    habitName: z.string(),
    deepReason: z.string(),
    visionStatement: z.string(),
    streakDays: z.number(),
    currentState: z.enum(['STRONG', 'NORMAL', 'DECLINING', 'CRITICAL']),
    daysSinceStart: z.number(),
    recentCompletionRate: z.number(),
  });
  export type MotivationContext = z.infer<typeof motivationContextSchema>;

  // æ•°æ®æ´å¯Ÿä¸Šä¸‹æ–‡
  export const habitDataSchema = z.object({
    habit: z.object({
      id: z.string(),
      name: z.string(),
      type: z.enum(['BUILD', 'BREAK']),
      currentPhase: z.number(),
      createdAt: z.date(),
    }),
    logs: z.array(z.object({
      loggedAt: z.date(),
      completed: z.boolean(),
      difficultyRating: z.number().optional(),
      moodBefore: z.number().optional(),
      moodAfter: z.number().optional(),
    })),
    stats: z.object({
      totalDays: z.number(),
      completedDays: z.number(),
      currentStreak: z.number(),
      longestStreak: z.number(),
      averageDifficulty: z.number().optional(),
    }),
  });
  export type HabitData = z.infer<typeof habitDataSchema>;

  // è§¦å‘è®°å½• (åä¹ æƒ¯æˆ’é™¤)
  export const triggerRecordSchema = z.object({
    timestamp: z.date(),
    triggerType: z.enum(['TEMPORAL', 'CONTEXTUAL', 'EMOTIONAL', 'BEHAVIORAL']),
    context: z.string(), // è§¦å‘æ—¶çš„åœºæ™¯æè¿°
    location: z.string().optional(),
    emotion: z.string().optional(),
    intensity: z.number().min(1).max(10), // å†²åŠ¨å¼ºåº¦
    resisted: z.boolean(), // æ˜¯å¦æˆåŠŸæŠµæŠ—
    copingStrategy: z.string().optional(), // ä½¿ç”¨çš„åº”å¯¹ç­–ç•¥
  });
  export type TriggerRecord = z.infer<typeof triggerRecordSchema>;

  // ============ v1.5 æŠ¥å‘Šç±»å‹å®šä¹‰ ============

  // å‘¨æŠ¥æ‘˜è¦
  export const reportSummarySchema = z.object({
    completionRate: z.number(),
    rateChange: z.number(), // è¾ƒä¸Šå‘¨å˜åŒ–
    activeHabits: z.number(),
    longestStreak: z.number(),
    totalCheckins: z.number(),
    perfectDays: z.number(), // å…¨éƒ¨å®Œæˆçš„å¤©æ•°
  });
  export type ReportSummary = z.infer<typeof reportSummarySchema>;

  // æŠ¥å‘Šäº®ç‚¹
  export const reportHighlightSchema = z.object({
    habitId: z.string(),
    habitName: z.string(),
    achievement: z.string(),
    emoji: z.string(),
    metric: z.string().optional(), // å…·ä½“æ•°æ®ï¼Œå¦‚ "è¿ç»­7å¤©"
  });
  export type ReportHighlight = z.infer<typeof reportHighlightSchema>;

  // æ¨¡å¼å‘ç°
  export const patternFindingSchema = z.object({
    finding: z.string(),
    implication: z.string(),
    confidence: z.number().min(0).max(1),
    dataPoints: z.number(), // æ”¯æ’‘æ•°æ®ç‚¹æ•°é‡
  });
  export type PatternFinding = z.infer<typeof patternFindingSchema>;

  // é‡Œç¨‹ç¢‘å›é¡¾
  export const milestoneReflectionSchema = z.object({
    journey: z.string(), // å†ç¨‹æ€»ç»“
    keyMoments: z.array(z.string()), // å…³é”®æ—¶åˆ»
    lessonsLearned: z.array(z.string()), // å­¦åˆ°çš„ç»éªŒ
    strengthsShown: z.array(z.string()), // å±•ç°çš„ä¼˜åŠ¿
  });
  export type MilestoneReflection = z.infer<typeof milestoneReflectionSchema>;

  // æ¸è¿›å¼é˜¶æ®µé…ç½®
  export const phaseConfigSchema = z.object({
    phase: z.number(),
    name: z.string(),
    duration: z.string(), // å¦‚ "7å¤©"
    microHabit: z.string(),
    successCriteria: z.string(),
    difficultyScore: z.number().min(1).max(10),
    startedAt: z.date().optional(),
    completedAt: z.date().optional(),
  });
  export type PhaseConfig = z.infer<typeof phaseConfigSchema>;
  ```

  ---

  ## 7. éåŠŸèƒ½éœ€æ±‚

  ### 7.1 æ€§èƒ½è¦æ±‚

  | æŒ‡æ ‡ | ç›®æ ‡å€¼ |
  |-----|-------|
  | é¡µé¢åŠ è½½ | < 2s |
  | AI å¯¹è¯å“åº” | < 3sï¼ˆé¦– tokenï¼‰ |
  | API å“åº” | < 200msï¼ˆé AIï¼‰ |
  | æ¨é€å»¶è¿Ÿ | < 30s |

  ### 7.2 å®‰å…¨è¦æ±‚

  - NextAuth.js v5 è®¤è¯ (Discord OAuth)
  - Session-based è®¤è¯ (NextAuth é»˜è®¤)
  - tRPC protectedProcedure ä¿æŠ¤æ•æ„Ÿç«¯ç‚¹
  - API Rate Limiting
  - æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
  - GDPR æ•°æ®åˆ é™¤æƒ

  ### 7.3 ç›‘æ§

  - Vercel Analyticsï¼ˆæ€§èƒ½ï¼‰
  - Sentryï¼ˆé”™è¯¯è¿½è¸ªï¼‰
  - PostHogï¼ˆç”¨æˆ·è¡Œä¸ºï¼‰

  ---

  ## 8. ç‰ˆæœ¬è¿­ä»£è§„åˆ’

  ### 8.1 ç‰ˆæœ¬è·¯çº¿æ€»è§ˆ

  ```
  v1.0 (MVP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åŸºç¡€ç‰ˆ
  â”œâ”€â”€ AI å¯¹è¯å¼ä¹ æƒ¯åˆ›å»º (æ¨¡å—ä¸€)
  â”œâ”€â”€ æ¯æ—¥æ‰“å¡è®°å½•
  â”œâ”€â”€ æ™ºèƒ½æé†’ç³»ç»Ÿ (æ¨¡å—äºŒ)
  â””â”€â”€ åŸºç¡€æ•°æ®çœ‹æ¿ (æ¨¡å—ä¸ƒ)

  v1.5 (å¢å¼º) â—€â”€â”€ å½“å‰å¼€å‘ç›®æ ‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¢å¼ºç‰ˆ
  â”œâ”€â”€ åä¹ æƒ¯æˆ’é™¤ä¸“é¡¹ (æ¨¡å—äº”)
  â”œâ”€â”€ åŠ¨æœºç»´æŠ¤ç³»ç»Ÿ (æ¨¡å—ä¸‰)
  â”œâ”€â”€ å‘¨æœŸæŠ¥å‘Šç³»ç»Ÿ (æ¨¡å—å…«) â­ æ–°å¢
  â””â”€â”€ è¿›é˜¶åˆ†æç³»ç»Ÿ (æ¨¡å—ä¹) â­ æ–°å¢

  v2.0 (ç¤¾äº¤) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç¤¾äº¤ç‰ˆ
  â”œâ”€â”€ ä¹ æƒ¯ç¤¾åŒº
  â”œâ”€â”€ é—®è´£ä¼™ä¼´
  â”œâ”€â”€ æˆå°±åˆ†äº«
  â””â”€â”€ æ’è¡Œæ¦œ

  v2.5 (æ™ºèƒ½) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ™ºèƒ½ç‰ˆ
  â”œâ”€â”€ è¡Œä¸ºé¢„æµ‹
  â”œâ”€â”€ è·¨ä¹ æƒ¯å…³è”
  â”œâ”€â”€ è¯­éŸ³äº¤äº’
  â””â”€â”€ æ™ºèƒ½æ‰‹è¡¨é›†æˆ
  ```

  ### 8.2 v1.5 è¯¦ç»†åŠŸèƒ½æ¸…å•

  #### 8.2.1 åä¹ æƒ¯æˆ’é™¤ä¸“é¡¹ (æ¨¡å—äº”)

  | åŠŸèƒ½ç‚¹ | æè¿° | ä¼˜å…ˆçº§ | çŠ¶æ€ |
  |-------|------|-------|------|
  | è§¦å‘æ¨¡å¼è¯†åˆ« | AI åˆ†æåä¹ æƒ¯çš„æ—¶é—´/æƒ…å¢ƒ/æƒ…ç»ªè§¦å‘æ¨¡å¼ | P0 | âœ… å·²å®Œæˆ |
  | æ›¿ä»£è¡Œä¸ºè®¾è®¡ | æ ¹æ®æ·±å±‚éœ€æ±‚æ¨èæ›¿ä»£è¡Œä¸º | P0 | âœ… å·²å®Œæˆ |
  | ç¯å¢ƒè®¾è®¡å»ºè®® | æä¾›å¢åŠ æ‰§è¡Œéšœç¢çš„å…·ä½“å»ºè®® | P1 | âœ… å·²å®Œæˆ |
  | å¤å‘ç®¡ç† | å…±æƒ…å“åº” + æ¨¡å¼åˆ†æ + ç­–ç•¥è¿­ä»£ | P0 | âœ… å·²å®Œæˆ |
  | è§¦å‘é“¾æ‰“æ–­ | å¯è§†åŒ–è§¦å‘é“¾å¹¶æä¾›æ‰“æ–­ç­–ç•¥ | P1 | âœ… å·²å®Œæˆ |

  > **å®ç°è¯´æ˜**: åˆ›å»ºäº† `src/components/break-habit/` ç»„ä»¶åº“ï¼ŒåŒ…å« `trigger-form.tsx`ã€`trigger-analysis.tsx`ã€`relapse-manager.tsx`ã€`environment-design.tsx`ã€‚åç«¯åœ¨ `analytics.ts` router ä¸­æ·»åŠ äº† `getTriggerAnalysis`ã€`getRelapseAnalysis`ã€`getEnvironmentDesign` ç«¯ç‚¹ã€‚

  #### 8.2.2 åŠ¨æœºç»´æŠ¤ç³»ç»Ÿ (æ¨¡å—ä¸‰)

  | åŠŸèƒ½ç‚¹ | æè¿° | ä¼˜å…ˆçº§ | çŠ¶æ€ |
  |-------|------|-------|------|
  | åŠ¨æœºæ³¢åŠ¨æ£€æµ‹ | åŸºäºæ‰“å¡æ•°æ®è¯†åˆ«åŠ¨æœºä¸‹é™è¶‹åŠ¿ | P0 | âœ… å·²å®Œæˆ |
  | å…³é”®å¹²é¢„ç‚¹ | Day 3/7/14/21 è‡ªåŠ¨è§¦å‘æ¿€åŠ± | P0 | âœ… å·²å®Œæˆ |
  | ä¸ªæ€§åŒ–æ¿€åŠ± | æ ¹æ®ç”¨æˆ·åŠ¨æœºç±»å‹ç”Ÿæˆå®šåˆ¶æ–‡æ¡ˆ | P0 | âœ… å·²å®Œæˆ |
  | æ„¿æ™¯å¯è§†åŒ– | å®šæœŸå›é¡¾ç”¨æˆ·è®¾å®šçš„æ„¿æ™¯å£°æ˜ | P1 | âœ… å·²å®Œæˆ |
  | æŸå¤±æé†’ | è®¡ç®—æ”¾å¼ƒçš„æœºä¼šæˆæœ¬ | P2 | å¾…å®ç° |

  > **å®ç°è¯´æ˜**: åç«¯ `src/lib/ai/motivation.ts` å®ç°äº†åŠ¨æœºç»´æŠ¤å¼•æ“ï¼ŒåŒ…å«åŠ¨æœºæ³¢åŠ¨æ£€æµ‹å’Œä¸ªæ€§åŒ–æ¿€åŠ±æ–‡æ¡ˆç”Ÿæˆã€‚

  #### 8.2.3 å‘¨æœŸæŠ¥å‘Šç³»ç»Ÿ (æ¨¡å—å…«) â­

  | åŠŸèƒ½ç‚¹ | æè¿° | ä¼˜å…ˆçº§ | çŠ¶æ€ |
  |-------|------|-------|------|
  | å‘¨æŠ¥ç”Ÿæˆ | æ¯å‘¨æ—¥è‡ªåŠ¨ç”Ÿæˆ AI å‘¨æŠ¥ | P0 | âœ… å·²å®Œæˆ |
  | æœˆæŠ¥ç”Ÿæˆ | æ¯æœˆæœ«è‡ªåŠ¨ç”Ÿæˆæœˆåº¦æŠ¥å‘Š | P0 | âœ… å·²å®Œæˆ |
  | é‡Œç¨‹ç¢‘æŠ¥å‘Š | 7/21/66å¤©è‡ªåŠ¨ç”Ÿæˆæˆå°±æŠ¥å‘Š | P0 | âœ… å·²å®Œæˆ |
  | æŠ¥å‘Šå†å² | æŸ¥çœ‹å†å²æŠ¥å‘Šï¼Œå¯¹æ¯”è¿›æ­¥ | P1 | âœ… å·²å®Œæˆ |
  | æŠ¥å‘Šåˆ†äº« | ç”Ÿæˆåˆ†äº«å¡ç‰‡åˆ°ç¤¾äº¤åª’ä½“ | P2 | å¾…å®ç° |
  | æŠ¥å‘Šè®¢é˜… | é‚®ä»¶/æ¨é€è®¢é˜…å‘¨æŠ¥ | P2 | å¾…å®ç° |

  > **å®ç°è¯´æ˜**: åˆ›å»ºäº† `/reports` æŠ¥å‘Šåˆ—è¡¨é¡µå’Œ `/reports/[id]` æŠ¥å‘Šè¯¦æƒ…é¡µã€‚åç«¯ `report.ts` router æä¾›å®Œæ•´çš„æŠ¥å‘Šç”Ÿæˆã€åˆ—è¡¨ã€è¯¦æƒ… APIã€‚ä½¿ç”¨ Vercel Cron Jobs å®šæ—¶è§¦å‘å‘¨æŠ¥/æœˆæŠ¥ç”Ÿæˆã€‚

  #### 8.2.4 è¿›é˜¶åˆ†æç³»ç»Ÿ (æ¨¡å—ä¹) â­

  | åŠŸèƒ½ç‚¹ | æè¿° | ä¼˜å…ˆçº§ | çŠ¶æ€ |
  |-------|------|-------|------|
  | æ—¶é—´çƒ­åŠ›å›¾ | å¯è§†åŒ–æœ€ä½³æ‰§è¡Œæ—¶é—´çª—å£ | P0 | âœ… å·²å®Œæˆ |
  | æƒ…ç»ªå…³è”åˆ†æ | åˆ†æä¹ æƒ¯ä¸æƒ…ç»ªçš„åŒå‘å…³ç³» | P1 | âœ… å·²å®Œæˆ |
  | ä¹ æƒ¯å…³è”çŸ©é˜µ | å‘ç°ä¹ æƒ¯é—´çš„æ­£/è´Ÿç›¸å…³å…³ç³» | P1 | âœ… å·²å®Œæˆ |
  | ä¸­æ–­é£é™©é¢„æµ‹ | æå‰é¢„è­¦ä¹ æƒ¯ä¸­æ–­é£é™© | P0 | âœ… å·²å®Œæˆ |
  | éš¾åº¦æ›²çº¿å›¾ | è¿½è¸ªä¸»è§‚éš¾åº¦éšæ—¶é—´çš„å˜åŒ– | P2 | âœ… å·²å®Œæˆ |
  | åˆ†æç¼“å­˜ | æ™ºèƒ½ç¼“å­˜åˆ†æç»“æœï¼Œæå‡æ€§èƒ½ | P1 | âœ… å·²å®Œæˆ |

  > **å®ç°è¯´æ˜**: åˆ›å»ºäº† `src/components/charts/` ç»„ä»¶åº“ï¼Œä½¿ç”¨ Recharts å®ç°æ•°æ®å¯è§†åŒ–ï¼š
  > - `time-heatmap.tsx` - æ—¶é—´çƒ­åŠ›å›¾ï¼ˆScatterChartï¼‰
  > - `completion-chart.tsx` - å®Œæˆç‡è¶‹åŠ¿å›¾ï¼ˆAreaChartï¼‰
  > - `mood-chart.tsx` - æƒ…ç»ªå˜åŒ–å›¾ï¼ˆLineChartï¼‰
  > - `streak-chart.tsx` - è¿ç»­å¤©æ•°å¯¹æ¯”å›¾ï¼ˆBarChartï¼‰
  > - `difficulty-chart.tsx` - éš¾åº¦åˆ†å¸ƒå›¾ï¼ˆRadarChartï¼‰
  > - `correlation-chart.tsx` - ä¹ æƒ¯å…³è”å±•ç¤º
  >
  > åç«¯ `analytics.ts` router æä¾›å®Œæ•´çš„åˆ†ææ•°æ® APIã€‚

  ### 8.3 v1.5 æŠ€æœ¯å®ç°è¦ç‚¹

  ```typescript
  // âœ… å·²å®ç° - tRPC Routers (å·²æ³¨å†Œåˆ° appRouter)
  src/server/api/routers/
  â”œâ”€â”€ report.ts      // å‘¨æœŸæŠ¥å‘Š âœ…
  â”œâ”€â”€ analytics.ts   // è¿›é˜¶åˆ†æ âœ…
  â”œâ”€â”€ habit.ts       // ä¹ æƒ¯ç®¡ç† âœ…
  â”œâ”€â”€ log.ts         // æ‰“å¡è®°å½• âœ…
  â”œâ”€â”€ insights.ts    // æ•°æ®æ´å¯Ÿ âœ…
  â””â”€â”€ reminder.ts    // æé†’ç³»ç»Ÿ âœ…

  // âœ… å·²å®ç° - AI åŠŸèƒ½æ¨¡å—
  src/lib/ai/
  â”œâ”€â”€ analytics.ts   // åˆ†æå‡½æ•°é›†åˆ âœ…
  â”œâ”€â”€ report.ts      // æŠ¥å‘Šç”Ÿæˆå‡½æ•° âœ…
  â”œâ”€â”€ motivation.ts  // åŠ¨æœºç»´æŠ¤å‡½æ•° âœ…
  â”œâ”€â”€ break-habit.ts // åä¹ æƒ¯åˆ†æ âœ…
  â”œâ”€â”€ ability.ts     // èƒ½åŠ›è¯„ä¼° âœ…
  â”œâ”€â”€ reminder.ts    // æé†’ç”Ÿæˆ âœ…
  â”œâ”€â”€ insights.ts    // æ´å¯Ÿç”Ÿæˆ âœ…
  â””â”€â”€ prompts.ts     // ç³»ç»Ÿæç¤ºè¯ âœ…

  // âœ… å·²å®ç° - å‰ç«¯ç»„ä»¶
  src/components/
  â”œâ”€â”€ charts/                    // Recharts æ•°æ®å¯è§†åŒ– âœ…
  â”‚   â”œâ”€â”€ time-heatmap.tsx       // æ—¶é—´çƒ­åŠ›å›¾
  â”‚   â”œâ”€â”€ completion-chart.tsx   // å®Œæˆç‡è¶‹åŠ¿
  â”‚   â”œâ”€â”€ mood-chart.tsx         // æƒ…ç»ªå˜åŒ–
  â”‚   â”œâ”€â”€ streak-chart.tsx       // è¿ç»­å¤©æ•°
  â”‚   â”œâ”€â”€ difficulty-chart.tsx   // éš¾åº¦åˆ†å¸ƒ
  â”‚   â””â”€â”€ correlation-chart.tsx  // ä¹ æƒ¯å…³è”
  â”œâ”€â”€ break-habit/               // åä¹ æƒ¯æˆ’é™¤ âœ…
  â”‚   â”œâ”€â”€ trigger-form.tsx       // è§¦å‘è®°å½•è¡¨å•
  â”‚   â”œâ”€â”€ trigger-analysis.tsx   // AI è§¦å‘åˆ†æ
  â”‚   â”œâ”€â”€ relapse-manager.tsx    // å¤å‘ç®¡ç†
  â”‚   â””â”€â”€ environment-design.tsx // ç¯å¢ƒè®¾è®¡å»ºè®®
  â””â”€â”€ ui/                        // shadcn/ui ç»„ä»¶ âœ…

  // âœ… å·²å®ç° - é¡µé¢
  src/app/(app)/
  â”œâ”€â”€ dashboard/page.tsx         // ä»ªè¡¨ç›˜ âœ…
  â”œâ”€â”€ habits/                    // ä¹ æƒ¯ç®¡ç† âœ…
  â”‚   â”œâ”€â”€ page.tsx               // ä¹ æƒ¯åˆ—è¡¨
  â”‚   â”œâ”€â”€ new/page.tsx           // æ–°å»ºä¹ æƒ¯
  â”‚   â””â”€â”€ [id]/                  // ä¹ æƒ¯è¯¦æƒ…
  â”‚       â”œâ”€â”€ page.tsx
  â”‚       â””â”€â”€ _components/
  â”‚           â””â”€â”€ habit-edit-dialog.tsx
  â”œâ”€â”€ coach/page.tsx             // AI æ•™ç»ƒ âœ…
  â”œâ”€â”€ reports/                   // æŠ¥å‘Šç³»ç»Ÿ âœ…
  â”‚   â”œâ”€â”€ page.tsx               // æŠ¥å‘Šåˆ—è¡¨
  â”‚   â””â”€â”€ [id]/page.tsx          // æŠ¥å‘Šè¯¦æƒ…
  â””â”€â”€ settings/page.tsx          // è®¾ç½®é¡µé¢ âœ…

  // âœ… å·²å®ç° - Vercel Cron Jobs
  vercel.json â†’ crons é…ç½® âœ…
  src/app/api/cron/
  â”œâ”€â”€ weekly-report/route.ts     // å‘¨æŠ¥ç”Ÿæˆ âœ…
  â””â”€â”€ daily-reminder/route.ts    // æ¯æ—¥æé†’ âœ…
  ```

  ### 8.4 v1.5 æ•°æ®åº“å˜æ›´

  ```prisma
  // æ–°å¢æšä¸¾
  enum ReportType { WEEKLY, MONTHLY, MILESTONE }
  enum MilestoneType { DAY_7, DAY_21, DAY_66, DAY_100, CUSTOM }

  // æ–°å¢æ¨¡å‹
  model Report { ... }           // å‘¨æœŸæŠ¥å‘Šå­˜å‚¨
  model Milestone { ... }        // é‡Œç¨‹ç¢‘è®°å½•
  model AnalyticsSnapshot { ... } // åˆ†æç»“æœç¼“å­˜
  ```

  ### 8.5 v2.0+ æ‰©å±•åŠŸèƒ½

  | åŠŸèƒ½ | æè¿° | ç‰ˆæœ¬ |
  |-----|------|------|
  | ä¹ æƒ¯ç¤¾åŒº | ç”¨æˆ·åˆ†äº«ä¹ æƒ¯å¿ƒå¾—å’ŒæŠ€å·§ | v2.0 |
  | é—®è´£ä¼™ä¼´ | åŒ¹é…äº’ç›¸ç›‘ç£çš„ä¼™ä¼´ | v2.0 |
  | æ’è¡Œæ¦œ | è¿ç»­å¤©æ•°/å®Œæˆç‡æ’å | v2.0 |
  | è¡Œä¸ºé¢„æµ‹ | é¢„æµ‹æ˜æ—¥å®Œæˆæ¦‚ç‡ | v2.5 |
  | è¯­éŸ³äº¤äº’ | Web Speech API è¯­éŸ³æ‰“å¡ | v2.5 |
  | å¯ç©¿æˆ´è®¾å¤‡ | Apple Watch/Wear OS é›†æˆ | v2.5 |
  | å®¶åº­/å›¢é˜Ÿç‰ˆ | å¤šäººåä½œä¹ æƒ¯å…»æˆ | v2.5 |
  | API å¼€æ”¾ | ç¬¬ä¸‰æ–¹åº”ç”¨é›†æˆ | v3.0 |

  ---

  ## é™„å½•

  ### A. æœ¯è¯­è¡¨

  | æœ¯è¯­ | å®šä¹‰ |
  |-----|------|
  | ç¦æ ¼è¡Œä¸ºæ¨¡å‹ | BJ Fogg æå‡ºï¼ŒB=MAP |
  | å¾®ä¹ æƒ¯ | æå…¶ç®€å•çš„ç›®æ ‡è¡Œä¸º |
  | é”šå®šä¹ æƒ¯ | æ–°ä¹ æƒ¯é™„ç€çš„å·²æœ‰ä¹ æƒ¯ |
  | è§¦å‘ç‚¹ | å¼•å‘è¡Œä¸ºçš„ä¿¡å· |

  ### B. å‚è€ƒèµ„æ–™

  - Fogg, BJ. "Tiny Habits"
  - Clear, James. "Atomic Habits"
  - [Vercel AI SDK Documentation](https://v6.ai-sdk.dev/llms.txt)
  - [Next.js Documentation](https://nextjs.org/docs)

  ---

  ## 9. v1.5 å®ç°è¿›åº¦æ€»ç»“

  ### 9.1 å®ŒæˆçŠ¶æ€æ¦‚è§ˆ

  | æ¨¡å— | P0 åŠŸèƒ½ | P1 åŠŸèƒ½ | P2 åŠŸèƒ½ | å®Œæˆåº¦ |
  |-----|--------|--------|--------|--------|
  | åä¹ æƒ¯æˆ’é™¤ä¸“é¡¹ | 4/4 | 1/1 | - | **100%** |
  | åŠ¨æœºç»´æŠ¤ç³»ç»Ÿ | 3/3 | 1/1 | 0/1 | **80%** |
  | å‘¨æœŸæŠ¥å‘Šç³»ç»Ÿ | 4/4 | 0/0 | 0/2 | **100% (P0-P1)** |
  | è¿›é˜¶åˆ†æç³»ç»Ÿ | 2/2 | 3/3 | 1/1 | **100%** |

  ### 9.2 æ ¸å¿ƒäº¤ä»˜ç‰©

  **åç«¯ (100% å®Œæˆ)**:
  - tRPC Routers: habit, log, report, analytics, insights, reminder
  - AI æ¨¡å—: break-habit, motivation, analytics, report, ability, reminder, insights, prompts
  - Vercel Cron Jobs: weekly-report, daily-reminder

  **å‰ç«¯ (95% å®Œæˆ)**:
  - é¡µé¢: dashboard, habits (list/new/detail), coach, reports (list/detail), settings
  - ç»„ä»¶åº“: charts (6ä¸ª Recharts å›¾è¡¨), break-habit (4ä¸ªç»„ä»¶), ui (shadcn)
  - å¾…å®Œå–„: æŠ¥å‘Šåˆ†äº«å¡ç‰‡ã€æŠ¥å‘Šè®¢é˜…

  ### 9.3 åç»­ä¼˜åŒ–å»ºè®®

  1. **P2 åŠŸèƒ½è¡¥é½**: æŸå¤±æé†’ã€æŠ¥å‘Šåˆ†äº«ã€æŠ¥å‘Šè®¢é˜…
  2. **UI ä¼˜åŒ–**: å›¾è¡¨äº¤äº’å¢å¼ºã€ç§»åŠ¨ç«¯é€‚é…
  3. **æ€§èƒ½ä¼˜åŒ–**: åˆ†æç»“æœç¼“å­˜ç­–ç•¥ã€å›¾è¡¨æ‡’åŠ è½½
  4. **æµ‹è¯•å®Œå–„**: å•å…ƒæµ‹è¯•ã€E2E æµ‹è¯•

  ---

  **æ–‡æ¡£ç‰ˆæœ¬**: v2.5 (v1.5 å®ç°è¿›åº¦æ›´æ–°)
  **æ›´æ–°æ—¥æœŸ**: 2025-11-29
  **æŠ€æœ¯æ¡†æ¶**: Next.js 15 + tRPC v11 + Prisma + NextAuth.js v5 + Vercel AI SDK v6
  **å½“å‰å¼€å‘çŠ¶æ€**: v1.5 æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼ŒP2 åŠŸèƒ½å¾…è¡¥é½
