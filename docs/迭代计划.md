# 习惯养成 Web 应用 v2.0 迭代计划

**基于福格行为模型深度对齐的系统重构**

---

| 文档信息 | |
|---------|---|
| 版本 | v2.0 迭代计划 |
| 日期 | 2025-12-01 |
| 基于版本 | v1.5 已完成 |
| 核心目标 | 深度对齐福格行为模型，修正当前系统偏差 |

---

## 一、迭代背景

### 1.1 v1.5 现状评估

v1.5 已完成功能：
- AI 对话式习惯配置
- 智能提醒系统
- 动机维护引擎
- 能力评估与任务拆解
- 坏习惯戒除系统（触发分析、复发管理）
- AI 教练对话
- 数据洞察与进阶分析
- 周期报告系统

### 1.2 核心问题识别

通过与福格行为模型原著《Tiny Habits》深度对比，发现以下系统性偏差：

| 问题领域 | 严重程度 | 影响范围 |
|---------|---------|---------|
| 庆祝机制完全缺失 | 🔴 致命 | 习惯固化失败 |
| 对动机过度依赖 | 🔴 严重 | 设计理念偏差 |
| 提示系统设计偏离 | 🟠 中等 | 锚点效果打折 |
| 入门步骤概念缺失 | 🟠 中等 | 微习惯不够"微" |
| 焦点地图工具缺失 | 🟡 一般 | 行为匹配不精准 |
| 过度工程化 | 🟡 一般 | 用户体验偏重 |

**福格核心观点回顾**：
> "情绪创造习惯。无须一味重复，无须讲究频次，无须盼望奇迹，只需积极的情绪。"
> "庆祝是习惯养成的'肥料'。每一次庆祝都会让相应的习惯牢牢地扎根。"
> "解决行为问题的顺序：提示 → 能力 → 动机"

### 1.3 迭代目标

> **核心理念转变**：从"数据分析驱动"转向"成功感驱动"

1. 补齐庆祝机制，让用户每次打卡都能"发光"
2. 重构问题解决优先级：提示 → 能力 → 动机
3. 强化锚点习惯设计，弱化情境推送
4. 引入入门步骤与缩小规模双策略
5. 简化复杂分析，强化即时反馈

---

## 二、版本规划总览

```
v2.0 福格对齐版 ──────────────────────────────────────────────────
├── Phase 1: 庆祝系统 (核心补齐) - Week 1-2
├── Phase 2: 习惯创建流程重构 - Week 3-4
├── Phase 3: 提示系统升级 - Week 5-6
├── Phase 4: 戒除流程标准化 - Week 7-8
├── Phase 5: 体验简化与优化 - Week 9-10
├── Phase 7: 习惯进阶系统 (微习惯→目标) - Week 11-14
└── Phase 8: 成就徽章系统 (增强庆祝) - Week 15-16

v2.5 社交版 (后续) ──────────────────────────────────────────────
├── 习惯社区
├── 问责伙伴
└── 成就分享
```

---

## 三、Phase 1: 庆祝系统（最高优先级）

### 3.1 功能概述

福格原理：**"情绪创造习惯，庆祝是习惯养成的肥料"**

ABC 三步骤中最被忽视的就是 C (Celebration)：

```
当前流程：
锚点 → 行为 → 打卡记录 → (无)

目标流程：
锚点 → 行为 → 打卡 → 【庆祝引导】→ 【发光感记录】
```

### 3.2 功能清单

| 功能点 | 描述 | 优先级 |
|-------|------|-------|
| 庆祝方式库 | 100种庆祝方式供用户选择收藏 | P0 |
| 打卡庆祝引导 | 打卡成功后立即触发庆祝提示 | P0 |
| 发光感评分 | 1-5分记录庆祝后的积极情绪 | P0 |
| 庆祝动画反馈 | Confetti 彩纸、火焰特效等视觉反馈 | P0 |
| 个性化庆祝推荐 | AI根据用户偏好推荐庆祝方式 | P1 |
| 庆祝三时机 | 想起时/执行中/完成后的庆祝引导 | P1 |
| 庆祝闪电战 | 随时随地为任何良好行为庆祝 | P2 |

### 3.3 数据模型扩展

```prisma
// 庆祝方式分类
enum CelebrationCategory {
  VERBAL      // 语言类：说"太棒了"
  PHYSICAL    // 动作类：挥拳、跳舞
  MENTAL      // 想象类：想象烟花绽放
  SENSORY     // 感官类：听欢呼声
}

// 庆祝方式库
model CelebrationMethod {
  id          String              @id @default(cuid())
  category    CelebrationCategory
  content     String              // 庆祝方式描述
  emoji       String?
  isBuiltIn   Boolean             @default(true)

  userFavorites UserCelebration[]
}

// 用户收藏的庆祝方式
model UserCelebration {
  id                  String            @id @default(cuid())
  userId              String
  user                User              @relation(fields: [userId], references: [id])
  celebrationMethodId String
  celebrationMethod   CelebrationMethod @relation(fields: [celebrationMethodId], references: [id])
  isDefault           Boolean           @default(false)
  useCount            Int               @default(0)

  @@unique([userId, celebrationMethodId])
}

// 扩展 HabitLog，增加庆祝记录
model HabitLog {
  // ... 现有字段

  // 新增庆祝相关
  celebratedAt        DateTime?
  celebrationMethodId String?
  shineScore          Int?      // 发光感评分 1-5
  celebrationNote     String?
}
```

### 3.4 核心界面设计

**打卡成功页面**：

```
┌─────────────────────────────────────────┐
│                                         │
│         🎉 太棒了！你做到了！            │
│                                         │
│    「早起」习惯 - 第 7 天连续完成        │
│                                         │
│         [彩纸动画飘落效果]               │
│                                         │
├─────────────────────────────────────────┤
│                                         │
│   现在，用你喜欢的方式庆祝一下！         │
│                                         │
│   ┌─────────┐  ┌─────────┐             │
│   │ 💪      │  │ 🎵      │             │
│   │ 挥拳说  │  │ 哼一首  │             │
│   │ "Yes!" │  │ 开心歌  │             │
│   └─────────┘  └─────────┘             │
│                                         │
│   ┌─────────┐  ┌─────────┐             │
│   │ 😊      │  │ ✨      │             │
│   │ 对自己  │  │ 想象烟花│             │
│   │ 微笑    │  │ 绽放    │             │
│   └─────────┘  └─────────┘             │
│                                         │
│            [ 更多庆祝方式 ]              │
│                                         │
├─────────────────────────────────────────┤
│                                         │
│   庆祝完了吗？感受一下此刻的"发光"感：   │
│                                         │
│   😐  🙂  😊  😄  🤩                    │
│   1   2   3   4   5                     │
│                                         │
│            [ 完成 ]                      │
│                                         │
└─────────────────────────────────────────┘
```

### 3.5 庆祝方式库（100种，摘自福格原著）

```typescript
// src/lib/celebration/methods.ts

export const CELEBRATION_METHODS = [
  // 语言类 (VERBAL)
  { category: 'VERBAL', content: '说"太棒了！"', emoji: '🎉' },
  { category: 'VERBAL', content: '说"Yes！"', emoji: '✊' },
  { category: 'VERBAL', content: '说"我做到了！"', emoji: '🏆' },
  { category: 'VERBAL', content: '说"干得好！"', emoji: '👏' },
  { category: 'VERBAL', content: '对自己说"我很棒"', emoji: '⭐' },
  { category: 'VERBAL', content: '哼几句喜欢的歌', emoji: '🎵' },

  // 动作类 (PHYSICAL)
  { category: 'PHYSICAL', content: '挥舞拳头', emoji: '💪' },
  { category: 'PHYSICAL', content: '给自己击掌', emoji: '🙌' },
  { category: 'PHYSICAL', content: '双手比赞', emoji: '👍' },
  { category: 'PHYSICAL', content: '跳一小段舞', emoji: '💃' },
  { category: 'PHYSICAL', content: '微微点头', emoji: '😌' },
  { category: 'PHYSICAL', content: '展露大大的微笑', emoji: '😊' },
  { category: 'PHYSICAL', content: '打个响指', emoji: '🫰' },
  { category: 'PHYSICAL', content: '拍拍手', emoji: '👏' },

  // 想象类 (MENTAL)
  { category: 'MENTAL', content: '想象烟花为你绽放', emoji: '🎆' },
  { category: 'MENTAL', content: '想象观众为你欢呼', emoji: '👥' },
  { category: 'MENTAL', content: '想象颁奖典礼', emoji: '🏅' },
  { category: 'MENTAL', content: '想象妈妈给你拥抱', emoji: '🤗' },
  { category: 'MENTAL', content: '想象孩子们为你鼓掌', emoji: '👶' },
  { category: 'MENTAL', content: '想象最好的朋友为你高兴', emoji: '👯' },

  // 感官类 (SENSORY)
  { category: 'SENSORY', content: '深呼吸，感受满足', emoji: '🌬️' },
  { category: 'SENSORY', content: '闭眼感受成就感', emoji: '😌' },
  { category: 'SENSORY', content: '看看窗外的天空', emoji: '🌤️' },

  // ... 更多方式，共100种
];
```

### 3.6 API 设计

```typescript
// src/server/api/routers/celebration.ts

export const celebrationRouter = createTRPCRouter({
  // 获取庆祝方式库
  getMethods: publicProcedure
    .input(z.object({
      category: z.nativeEnum(CelebrationCategory).optional(),
    }))
    .query(async ({ ctx, input }) => {
      return ctx.db.celebrationMethod.findMany({
        where: input.category ? { category: input.category } : undefined,
      });
    }),

  // 获取用户收藏的庆祝方式
  getUserFavorites: protectedProcedure
    .query(async ({ ctx }) => {
      return ctx.db.userCelebration.findMany({
        where: { userId: ctx.session.user.id },
        include: { celebrationMethod: true },
        orderBy: { useCount: 'desc' },
      });
    }),

  // 收藏庆祝方式
  addFavorite: protectedProcedure
    .input(z.object({ methodId: z.string() }))
    .mutation(async ({ ctx, input }) => {
      return ctx.db.userCelebration.create({
        data: {
          userId: ctx.session.user.id,
          celebrationMethodId: input.methodId,
        },
      });
    }),

  // 记录庆祝（打卡后调用）
  recordCelebration: protectedProcedure
    .input(z.object({
      logId: z.string(),
      methodId: z.string().optional(),
      shineScore: z.number().min(1).max(5),
      note: z.string().optional(),
    }))
    .mutation(async ({ ctx, input }) => {
      // 更新打卡记录
      await ctx.db.habitLog.update({
        where: { id: input.logId },
        data: {
          celebratedAt: new Date(),
          celebrationMethodId: input.methodId,
          shineScore: input.shineScore,
          celebrationNote: input.note,
        },
      });

      // 更新庆祝方式使用次数
      if (input.methodId) {
        await ctx.db.userCelebration.updateMany({
          where: {
            userId: ctx.session.user.id,
            celebrationMethodId: input.methodId,
          },
          data: { useCount: { increment: 1 } },
        });
      }
    }),
});
```

### 3.7 技术依赖

```json
{
  "canvas-confetti": "^1.9.0",   // 彩纸动画
  "framer-motion": "^11.0.0",    // React动画
  "use-sound": "^4.0.0"          // 音效Hook（可选）
}
```

### 3.8 庆祝三时机设计（P1）

福格原著：
> "在3个不同的时机进行庆祝：你想起要执行新习惯的时刻、你正在执行新习惯的时刻，以及你刚刚完成新习惯的时刻。每一个时机都有不同的效果。"

```
庆祝时机     │ 效果                              │ 实现方式
─────────────┼───────────────────────────────────┼──────────────────────────
想起时       │ 强化提示与习惯的联结               │ 提醒通知中包含庆祝引导
执行中       │ 让行为过程更愉悦                   │ 执行界面的实时鼓励
完成后       │ 将行为固化为习惯（最重要）          │ 打卡成功页的庆祝流程
```

**实现界面**：

```
┌─────────────────────────────────────────────┐
│  ⏰ 习惯提醒：早起                           │
├─────────────────────────────────────────────┤
│                                             │
│  是时候执行「早起」习惯了！                   │
│                                             │
│  💡 想起时庆祝：                             │
│  "太棒了，我记得要做这件事！" 👏              │
│                                             │
│  先在心里为自己鼓掌，然后开始行动吧！         │
│                                             │
│         [ 开始执行 ]  [ 稍后提醒 ]            │
│                                             │
└─────────────────────────────────────────────┘

执行中界面：
┌─────────────────────────────────────────────┐
│  🏃 正在执行：早起                           │
├─────────────────────────────────────────────┤
│                                             │
│  你正在做这件事，已经很棒了！                 │
│                                             │
│  💪 执行中庆祝：                             │
│  "我正在变成更好的自己"                      │
│                                             │
│  享受这个过程，不用着急 ✨                    │
│                                             │
│            [ 完成打卡 ]                      │
│                                             │
└─────────────────────────────────────────────┘
```

### 3.9 32种肯定成功语言框架（P1）

福格提供了8种情境×4种类型的肯定语言矩阵，用于AI教练和周报反馈：

```typescript
// src/lib/celebration/affirmation-matrix.ts

type AffirmationType =
  | 'PERFORMANCE'      // 你的出色表现
  | 'COMPARISON'       // 与别人相比
  | 'COLLABORATION'    // 合作时的表现
  | 'SILVER_LINING';   // 尽管表现不佳但有好消息

type AffirmationContext =
  | 'SINGLE_SUCCESS'   // 仅此一次成功
  | 'PERSONAL_BEST'    // 最棒的一次
  | 'IMPROVEMENT'      // 与上次相比进步
  | 'MILESTONE'        // 达到里程碑
  | 'TREND'            // 发展趋势向好
  | 'EFFORT'           // 持续努力
  | 'COULD_BE_WORSE'   // 情况本可能更糟
  | 'CHALLENGE'        // 勇于接受挑战

// 示例模板
const AFFIRMATION_TEMPLATES: Record<AffirmationContext, Record<AffirmationType, string>> = {
  SINGLE_SUCCESS: {
    PERFORMANCE: '你成功完成了「{habit}」！',
    COMPARISON: '今天你比大多数人都更自律！',
    COLLABORATION: '你的坚持正在影响身边的人',
    SILVER_LINING: '虽然只完成了最低标准，但你没有放弃',
  },
  PERSONAL_BEST: {
    PERFORMANCE: '这是你「{habit}」习惯的最佳记录！',
    COMPARISON: '你创造了新纪录，连续{days}天！',
    COLLABORATION: '你是帮助自己创造新纪录的关键人物',
    SILVER_LINING: '虽然今天状态不好，但你的最佳记录依然保持着',
  },
  IMPROVEMENT: {
    PERFORMANCE: '相比上周，你的完成率提升了{percent}%！',
    COMPARISON: '你的进步速度超过了平均水平',
    COLLABORATION: '你正在帮助自己成为更好的人',
    SILVER_LINING: '虽然今天漏掉了，但整体趋势是向上的',
  },
  MILESTONE: {
    PERFORMANCE: '恭喜！你达到了{days}天的里程碑！',
    COMPARISON: '能坚持{days}天的人不到10%，你做到了！',
    COLLABORATION: '你的里程碑成就值得与朋友分享',
    SILVER_LINING: '虽然中断了，但你曾达到{days}天的里程碑',
  },
  // ... 其他情境
};

// 根据用户数据生成个性化肯定语言
export function generateAffirmation(
  habit: Habit,
  logs: HabitLog[],
  userPreference: AffirmationType = 'PERFORMANCE',
): string {
  const context = detectAffirmationContext(logs);
  const template = AFFIRMATION_TEMPLATES[context][userPreference];
  return fillTemplate(template, { habit, logs });
}
```

**在周报中的应用**：

```
┌─────────────────────────────────────────────┐
│  📊 本周报告：你的成功故事                    │
├─────────────────────────────────────────────┤
│                                             │
│  🏆 本周亮点                                 │
│                                             │
│  【个人表现】                                │
│  "你成功完成了42次打卡，太棒了！"             │
│                                             │
│  【里程碑达成】                              │
│  "恭喜！「早起」习惯达到了21天里程碑！"       │
│                                             │
│  【持续进步】                                │
│  "相比上周，你的整体完成率提升了15%！"        │
│                                             │
│  【挑战克服】                                │
│  "尽管周三很忙，你依然坚持完成了习惯"         │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 四、Phase 2: 习惯创建流程重构

### 4.1 功能概述

福格原理：
- **愿望 → 行为集群 → 黄金行为**：先明确愿望，再探索多种行为，最后筛选
- **焦点地图**：影响力 × 可行性矩阵选择右上角行为
- **入门步骤 vs 缩小规模**：两种"容易做"策略
- **微习惯配方**：锚点 + 行为 + 庆祝的标准格式

### 4.2 功能清单

| 功能点 | 描述 | 优先级 |
|-------|------|-------|
| 愿望明确引导 | AI引导用户明确愿望而非直接设定行为 | P0 |
| 行为集群生成 | "挥舞魔法棒"探索多种可能行为 | P0 |
| 焦点地图评估 | 影响力×可行性矩阵筛选黄金行为 | P0 |
| 双策略选择 | 明确区分入门步骤/缩小规模 | P0 |
| 微习惯配方卡 | 标准化配方格式输出 | P1 |
| 配方演练引导 | 引导用户演练7-10次 | P1 |
| **毛伊习惯引导** | **新用户首个习惯推荐，教会"感受成功"** | **P1** |
| **去激励因素识别** | **识别并移除恐惧/焦虑等阻碍因素** | **P1** |

### 4.3 重构后的对话流程

```
Step 1: 愿望明确
┌─────────────────────────────────────────────┐
│ AI: "你好！先告诉我，你心中的愿望是什么？    │
│      不用考虑具体怎么做，只描述你想要的结果。"│
│                                             │
│ 用户: "我想变得更健康"                       │
│                                             │
│ AI: "变得更健康是个美好的愿望！              │
│      能具体说说，健康对你意味着什么吗？       │
│      比如：精力充沛？身材变好？少生病？"      │
└─────────────────────────────────────────────┘
                    ↓
Step 2: 行为集群探索 ("挥舞魔法棒")
┌─────────────────────────────────────────────┐
│ AI: "假设你有魔法棒，可以让自己做出任何行为   │
│      来实现'精力充沛'，你会想到哪些？         │
│      不用考虑现不现实，尽量多想几个。"        │
│                                             │
│ 用户: "早睡、运动、少吃外卖、喝水..."        │
│                                             │
│ AI: "很好，还有呢？"                         │
│ AI: "一次就能完成的行为呢？比如买个水杯？"   │
│ AI: "有什么想停止的行为吗？比如熬夜？"       │
└─────────────────────────────────────────────┘
                    ↓
Step 3: 焦点地图筛选
┌─────────────────────────────────────────────┐
│ AI: "我帮你整理了这些行为，现在来找出         │
│      最适合你的'黄金行为'。"                 │
│                                             │
│      [显示焦点地图]                          │
│                                             │
│         影响力                               │
│        高│  早睡    运动                     │
│          │    ★      ○                      │
│          │                                   │
│          │  喝水    买水杯                   │
│        低│   ●       ◇                      │
│          └─────────────────                  │
│            难做    容易做                    │
│                                             │
│ AI: "右上角的行为最值得投入。                │
│      '喝水'容易做且有一定影响力，             │
│      我们从这个开始怎么样？"                  │
└─────────────────────────────────────────────┘
                    ↓
Step 4: 容易做设计 (双策略)
┌─────────────────────────────────────────────┐
│ AI: "让'喝水'变得超级容易，有两种方式：       │
│                                             │
│      【入门步骤】关注启动行为的第一步         │
│       → 把水杯放在桌上                       │
│                                             │
│      【缩小规模】缩小行为本身的规模           │
│       → 每次只喝一小口                       │
│                                             │
│      你更喜欢哪种方式？"                     │
└─────────────────────────────────────────────┘
                    ↓
Step 5: 锚点匹配 (详见 Phase 3)
                    ↓
Step 6: 配方生成
┌─────────────────────────────────────────────┐
│     ┌────────────────────────────┐          │
│     │  🎯 我的微习惯配方          │          │
│     ├────────────────────────────┤          │
│     │                            │          │
│     │  在我【坐到工位】之后，     │          │
│     │  我会【喝一小口水】。       │          │
│     │                            │          │
│     │  为了让大脑记住，我要：     │          │
│     │  【对自己点头说"不错"】     │          │
│     │                            │          │
│     └────────────────────────────┘          │
│                                             │
│ AI: "这就是你的微习惯配方！                  │
│      现在，让我们演练几次..."                │
└─────────────────────────────────────────────┘
                    ↓
Step 7: 配方演练
┌─────────────────────────────────────────────┐
│ AI: "闭上眼睛，想象一下：                    │
│                                             │
│      你坐到工位...                           │
│      拿起水杯，喝一小口...                   │
│      对自己点头，心里说'不错'...             │
│                                             │
│      感受到那种'发光'的感觉了吗？            │
│                                             │
│      很好！再演练几次，让大脑记住这个流程。"  │
│                                             │
│      演练进度：●●●○○○○ 3/7                  │
└─────────────────────────────────────────────┘
```

### 4.4 数据模型扩展

```prisma
// 愿望（用户的顶层目标）
model Aspiration {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  description String
  category    String?

  behaviorClusters BehaviorCluster[]
  habits           Habit[]

  createdAt   DateTime @default(now())

  @@index([userId])
}

// 行为集群（探索阶段产生的行为选项）
model BehaviorCluster {
  id            String     @id @default(cuid())
  aspirationId  String
  aspiration    Aspiration @relation(fields: [aspirationId], references: [id])

  behaviors     Json       // 行为列表，含影响力和可行性评分
  focusMapData  Json?      // 焦点地图数据

  createdAt     DateTime   @default(now())
}

// 容易做策略枚举
enum EasyStrategy {
  STARTER_STEP  // 入门步骤
  SCALE_DOWN    // 缩小规模
}

// 扩展 Habit 模型
model Habit {
  // ... 现有字段

  // 新增：关联愿望
  aspirationId    String?
  aspiration      Aspiration? @relation(fields: [aspirationId], references: [id])

  // 新增：容易做策略
  easyStrategy    EasyStrategy  @default(SCALE_DOWN)
  starterStep     String?       // 入门步骤描述
  scaledBehavior  String?       // 缩小后的行为描述

  // 新增：配方相关
  recipeAnchor      String?     // 锚点行为
  recipeBehavior    String?     // 微行为
  recipeCelebration String?     // 庆祝方式

  // 新增：演练记录
  rehearsalCount    Int         @default(0)
  rehearsedAt       DateTime?
}
```

### 4.5 焦点地图 AI 实现

```typescript
// src/lib/ai/focus-map.ts
import { generateObject } from 'ai';
import { z } from 'zod';

const focusMapSchema = z.object({
  behaviors: z.array(z.object({
    name: z.string(),
    description: z.string(),
    impactScore: z.number().min(1).max(10),      // 影响力
    feasibilityScore: z.number().min(1).max(10), // 可行性
    quadrant: z.enum(['GOLDEN', 'HIGH_IMPACT', 'EASY_WIN', 'AVOID']),
    recommendation: z.string(),
  })),
  goldenBehavior: z.object({
    name: z.string(),
    reason: z.string(),
  }),
});

export async function generateFocusMap(
  aspiration: string,
  behaviors: string[],
  userContext: UserContext,
) {
  const { object } = await generateObject({
    model: 'openai/gpt-4o',
    system: `你是行为设计专家。根据福格行为模型，帮助用户在焦点地图上定位行为。

焦点地图四象限：
- 右上角 GOLDEN（黄金行为）：高影响力 + 高可行性 → 最值得投入
- 左上角 HIGH_IMPACT：高影响力 + 低可行性 → 需要简化后再做
- 右下角 EASY_WIN：低影响力 + 高可行性 → 快速胜利，建立信心
- 左下角 AVOID：低影响力 + 低可行性 → 暂时不考虑

黄金行为三标准：
1. 能实现愿望（影响力）
2. 用户想做（动机）
3. 用户能做（能力）`,
    prompt: `用户愿望：${aspiration}
用户列出的行为：${behaviors.join('、')}
用户背景：${JSON.stringify(userContext)}

请为每个行为评估影响力和可行性，并推荐黄金行为。`,
    schema: focusMapSchema,
  });

  return object;
}
```

### 4.6 毛伊习惯引导（P1）

福格原著：
> "请你每天早上一起床就立刻说出这句话：'今天又是美好的一天！'并在说出这句话的同时，尽量去感受乐观和积极的心态。"

**毛伊习惯的意义**：
- 作为新用户的第一个习惯，教会用户"感受成功"的技能
- 简单到不可能失败（只需3秒）
- 每天都能练习庆祝

```
新用户引导流程：
┌─────────────────────────────────────────────┐
│  👋 欢迎来到微习惯之旅！                      │
├─────────────────────────────────────────────┤
│                                             │
│  在开始创建你自己的习惯之前，                 │
│  让我先教你一个魔法技巧：【庆祝】             │
│                                             │
│  🌅 毛伊习惯                                 │
│  ┌─────────────────────────────────────┐   │
│  │                                      │   │
│  │  每天早上一起床，                     │   │
│  │  对自己说："今天又是美好的一天！"     │   │
│  │                                      │   │
│  │  然后，感受那种乐观的心态。           │   │
│  │  只需要3秒钟。                        │   │
│  │                                      │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  这个练习能帮助你：                          │
│  ✓ 学会"感受成功"                           │
│  ✓ 体验庆祝带来的积极情绪                    │
│  ✓ 为更多习惯打下基础                        │
│                                             │
│       [ 我要试试毛伊习惯 ]                    │
│       [ 跳过，直接创建习惯 ]                  │
│                                             │
└─────────────────────────────────────────────┘
```

### 4.7 去激励因素识别（P1）

福格原著：
> "希望和恐惧是相互排斥的两个动机向量。如果你能够移除恐惧向量，那么希望将占据主导地位。"

**核心概念**：在创建习惯时，识别并移除阻碍用户行动的恐惧、焦虑等去激励因素。

```typescript
// src/lib/ai/demotivator-analysis.ts

const demotivatorSchema = z.object({
  demotivators: z.array(z.object({
    type: z.enum([
      'FEAR_OF_FAILURE',     // 害怕失败
      'FEAR_OF_JUDGMENT',    // 害怕被评判
      'OVERWHELM',           // 感到压倒性
      'PAST_FAILURE',        // 过去失败的阴影
      'PERFECTIONISM',       // 完美主义
      'TIME_SCARCITY',       // 时间不够
      'ENERGY_SCARCITY',     // 精力不够
    ]),
    description: z.string(),
    severity: z.number().min(1).max(5),
  })),
  removalStrategies: z.array(z.object({
    demotivatorType: z.string(),
    strategy: z.string(),
    microAction: z.string(),  // 立即可做的微小行动
  })),
});

export async function analyzeDemotivators(
  aspiration: string,
  selectedBehavior: string,
  userConcerns: string[],
) {
  const { object } = await generateObject({
    model: 'openai/gpt-4o',
    system: `你是行为设计专家。帮助用户识别并移除阻碍行动的去激励因素。

福格原理：
- 动机 = 希望 - 恐惧
- 移除恐惧可以让希望占主导
- 不要与去激励因素硬碰硬，而是设计绕过它

移除策略：
1. 让行为小到不可能失败（消除失败恐惧）
2. 私下进行，不公开承诺（消除评判恐惧）
3. 不设时间限制（消除压倒感）
4. 重新定义成功（消除完美主义）`,
    prompt: `用户愿望：${aspiration}
选择的行为：${selectedBehavior}
用户表达的担忧：${userConcerns.join('、')}

请识别去激励因素并提供移除策略。`,
    schema: demotivatorSchema,
  });

  return object;
}
```

**在习惯创建流程中的应用**：

```
Step 3.5: 去激励因素检查（新增）
┌─────────────────────────────────────────────┐
│ AI: "在开始之前，我想了解一下：              │
│      关于'每天运动'，有什么让你担心的吗？"    │
│                                             │
│ 用户: "我之前试过好多次都失败了"              │
│       "我怕坚持不下来"                        │
│                                             │
│ AI: "我理解，过去的经历会让人有顾虑。         │
│                                             │
│      让我帮你移除这些担忧：                   │
│                                             │
│      ❌ 担忧：害怕再次失败                    │
│      ✅ 解决：我们把行为缩小到'穿上运动鞋'    │
│         → 这个小到不可能失败！                │
│                                             │
│      ❌ 担忧：坚持不下来                      │
│      ✅ 解决：不设任何时间目标，只关注今天    │
│         → 每一次完成都是100%成功              │
│                                             │
│      感觉好一点了吗？"                        │
└─────────────────────────────────────────────┘
```

---

## 五、Phase 3: 提示系统升级

### 5.1 功能概述

福格原理：
- **行动提示（锚点）> 情境提示 > 人物提示**
- **锚点三维匹配**：物理位置 + 频率 + 主题

### 5.2 功能清单

| 功能点 | 描述 | 优先级 |
|-------|------|-------|
| 日程清单工具 | 帮助用户梳理每日既有习惯 | P0 |
| 锚点智能匹配 | AI基于三维度推荐最佳锚点 | P0 |
| 锚点验证检查 | 检查锚点是否足够可靠 | P1 |
| 情境提示降级 | 弱化App推送，作为备选 | P1 |
| 珍珠习惯设计 | 将烦恼转化为正向提示 | P2 |
| 顺便习惯发现 | 发现等待时间的习惯机会 | P2 |

### 5.3 日程清单工具

```
┌─────────────────────────────────────────────┐
│  📋 我的日常日程清单                         │
│                                             │
│  列出你每天都会做的事情，越详细越好。         │
│  这些将成为新习惯的"锚点"。                  │
│                                             │
├─────────────────────────────────────────────┤
│  🌅 早晨（起床到出门）                       │
│  ┌─────────────────────────────────────┐   │
│  │ ☑ 闹钟响起                           │   │
│  │ ☑ 双脚落地                           │   │
│  │ ☑ 上厕所                             │   │
│  │ ☑ 刷牙                               │   │
│  │ ☑ 洗脸                               │   │
│  │ ☑ 穿衣服                             │   │
│  │ ☑ 吃早餐                             │   │
│  │ ☑ 出门                               │   │
│  │ + 添加更多...                         │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  🏢 工作时段                                │
│  ...                                        │
│                                             │
│  🌙 晚间                                    │
│  ...                                        │
│                                             │
└─────────────────────────────────────────────┘
```

### 5.4 锚点智能匹配

```typescript
// src/lib/ai/anchor-matching.ts

const anchorMatchingSchema = z.object({
  recommendedAnchors: z.array(z.object({
    anchor: z.string(),
    matchScore: z.number().min(0).max(100),
    matchReasons: z.object({
      locationMatch: z.boolean(),   // 物理位置匹配
      frequencyMatch: z.boolean(),  // 频率匹配
      themeMatch: z.boolean(),      // 主题匹配
    }),
    warning: z.string().optional(),
  })),
  bestMatch: z.string(),
  recipePreview: z.string(), // 预览配方
});

export async function matchAnchor(
  newHabit: string,
  habitLocation: string,
  habitFrequency: string,
  dailyRoutines: DailyRoutine[],
) {
  const { object } = await generateObject({
    model: 'openai/gpt-4o',
    system: `你是锚点匹配专家。根据福格行为模型，帮助用户找到最佳锚点。

锚点匹配三维度：
1. 物理位置：新习惯和锚点应在同一地点发生
2. 频率：新习惯频率应与锚点频率一致（如每天一次）
3. 主题：锚点和新习惯的目的/主题应契合

优先选择：
- 稳定可靠的日程（每天必做的事）
- 有明确结束点的行为（如"刷完牙"而非"刷牙中"）
- 与新习惯自然衔接的行为

配方格式："在我【锚点行为】之后，我会【新习惯】。"`,
    prompt: `新习惯：${newHabit}
习惯地点：${habitLocation}
习惯频率：${habitFrequency}
用户日程：${JSON.stringify(dailyRoutines)}

请推荐最佳锚点。`,
    schema: anchorMatchingSchema,
  });

  return object;
}
```

### 5.5 珍珠习惯与顺便习惯

**珍珠习惯**：将烦恼转化为提示
```
用户烦恼："空调关停的声音打扰睡眠"
转化为珍珠习惯："当空调关停时，我会做3次深呼吸放松身体"
```

**顺便习惯**：利用等待碎片时间
```
等待时刻："等咖啡机煮咖啡（2分钟）"
顺便习惯："在咖啡煮好之前，我会做5个深蹲"
```

---

## 六、Phase 4: 戒除流程标准化

### 6.1 功能概述

福格的戒除三步法：**提示 → 能力 → 动机**（按顺序尝试）

> "解决行为问题的顺序：先检查提示，再检查能力，最后检查动机。"

### 6.2 福格行为改变系统的三个阶段

福格的完整行为改变系统包含三个阶段：

```
阶段1：创建新习惯 → 已在 Phase 2 覆盖
阶段2：终止习惯 → 本节 6.3-6.4
阶段3：扩展习惯（替换）→ 本节 6.5
```

### 6.3 功能清单

| 功能点 | 描述 | 优先级 |
|-------|------|-------|
| 戒除流程引导 | 标准化三步流程界面（阶段2） | P0 |
| 提示策略工具 | 移除/规避/忽略提示的具体方法 | P0 |
| 能力障碍设计 | 增加执行难度的5个维度 | P0 |
| 动机调整（备选）| 作为最后手段 | P1 |
| **习惯替换流程** | **将旧习惯替换为新习惯（阶段3）** | **P0** |
| 替代行为匹配 | AI为坏习惯推荐替代行为 | P1 |

### 6.4 戒除流程界面（阶段2：终止习惯）

```
┌─────────────────────────────────────────────┐
│  🚫 戒除习惯：刷手机                         │
│                                             │
│  按照福格方法，我们依次尝试三个策略：         │
│                                             │
├─────────────────────────────────────────────┤
│                                             │
│  第1步：处理提示 (最优先)                    │
│  ┌─────────────────────────────────────┐   │
│  │ 什么提示让你想刷手机？                │   │
│  │ ☑ 手机放在床头                       │   │
│  │ ☑ 听到通知声                         │   │
│  │ ☐ 无聊的时候                         │   │
│  │                                      │   │
│  │ 针对这些提示，你可以：                │   │
│  │ • 移除：把手机放到另一个房间          │   │
│  │ • 规避：睡前1小时不带手机进卧室       │   │
│  │ • 忽略：关闭通知声音                  │   │
│  │                                      │   │
│  │ [ 试试这个策略 ]                      │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ─ ─ ─ ─ 上面的不管用？继续 ─ ─ ─ ─ ─ ─ ─  │
│                                             │
│  第2步：增加执行难度                         │
│  ┌─────────────────────────────────────┐   │
│  │ 让刷手机变得更难：                    │   │
│  │                                      │   │
│  │ ⏱ 时间：设置App使用时间限制           │   │
│  │ 💪 体力：手机放到需要起身才能拿的地方  │   │
│  │ 🧠 脑力：设置复杂的解锁密码           │   │
│  │ 📅 日程：安排其他活动填满时间         │   │
│  │                                      │   │
│  │ [ 试试这些策略 ]                      │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ─ ─ ─ ─ 还是不管用？继续 ─ ─ ─ ─ ─ ─ ─ ─  │
│                                             │
│  第3步：调整动机 (最后手段)                  │
│  ┌─────────────────────────────────────┐   │
│  │ • 思考刷手机带来的负面影响            │   │
│  │ • 找到替代行为满足同样需求            │   │
│  │ • 设置后果提醒                        │   │
│  └─────────────────────────────────────┘   │
│                                             │
└─────────────────────────────────────────────┘
```

### 6.5 习惯替换流程（阶段3：扩展习惯）

福格原理：
> "将提示从以前的习惯重新设计到新习惯。让新习惯容易做到，让旧习惯难以做到。"

**核心概念**：不是简单地"戒掉"坏习惯，而是用一个能满足同样需求的好习惯来"替换"它。

```
┌─────────────────────────────────────────────┐
│  🔄 习惯替换：用好习惯替代坏习惯             │
├─────────────────────────────────────────────┤
│                                             │
│  你想戒掉的习惯：                            │
│  ┌─────────────────────────────────────┐   │
│  │ 🚫 无聊时刷手机                       │   │
│  │    触发提示：无聊、等待、焦虑          │   │
│  │    满足需求：消遣、逃避、即时满足       │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  AI推荐的替代习惯：                          │
│  ┌─────────────────────────────────────┐   │
│  │ ✅ 做3次深呼吸                        │   │
│  │    同样满足：放松、暂停                │   │
│  │    优势：更快、更健康、无副作用        │   │
│  ├─────────────────────────────────────┤   │
│  │ ✅ 看窗外30秒                         │   │
│  │    同样满足：休息、转移注意力          │   │
│  │    优势：保护眼睛、接触自然            │   │
│  ├─────────────────────────────────────┤   │
│  │ ✅ 喝一口水                           │   │
│  │    同样满足：做点什么、小奖励          │   │
│  │    优势：健康、简单                    │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  选择一个替代习惯后，我们将：                 │
│  1. 将旧提示重新绑定到新习惯                 │
│  2. 让新习惯超级容易做到                     │
│  3. 让旧习惯变得更难做到                     │
│  4. 每次执行新习惯后庆祝                     │
│                                             │
│            [ 开始替换 ]                      │
│                                             │
└─────────────────────────────────────────────┘
```

#### 6.5.1 替换流程实现

```typescript
// src/lib/ai/habit-swap.ts

const habitSwapSchema = z.object({
  oldHabit: z.object({
    name: z.string(),
    triggers: z.array(z.string()),      // 触发提示
    needs: z.array(z.string()),         // 满足的需求
  }),
  replacementOptions: z.array(z.object({
    name: z.string(),
    satisfiesNeeds: z.array(z.string()), // 能满足哪些相同需求
    advantages: z.array(z.string()),
    microVersion: z.string(),            // 微习惯版本
    starterStep: z.string(),             // 入门步骤
  })),
  recommendedChoice: z.string(),
  swapRecipe: z.string(),                // 替换配方
});

export async function generateHabitSwap(
  oldHabit: string,
  userContext: UserContext,
) {
  const { object } = await generateObject({
    model: 'openai/gpt-4o',
    system: `你是习惯替换专家。根据福格行为模型，帮助用户找到能替代坏习惯的好习惯。

替换原则：
1. 新习惯必须能满足旧习惯的核心需求
2. 新习惯必须比旧习惯更容易做到
3. 新习惯应该更健康、更有益
4. 使用相同的触发提示

替换配方格式：
"当我【旧提示】时，我不再【旧习惯】，而是【新习惯】。"`,
    prompt: `用户想戒掉的习惯：${oldHabit}
用户背景：${JSON.stringify(userContext)}

请分析这个习惯满足的需求，并推荐3个替代习惯。`,
    schema: habitSwapSchema,
  });

  return object;
}
```

#### 6.5.2 替换成功的关键

```typescript
// 替换习惯的三步设计
interface HabitSwapDesign {
  // 步骤1：提示重定向
  promptRedirect: {
    oldTrigger: string;      // 原来触发坏习惯的提示
    newBinding: string;      // 绑定到新习惯
  };

  // 步骤2：能力调整
  abilityAdjust: {
    makeNewEasier: string[]; // 让新习惯更容易的方法
    makeOldHarder: string[]; // 让旧习惯更难的方法
  };

  // 步骤3：庆祝巩固
  celebration: {
    method: string;          // 庆祝方式
    timing: 'during' | 'after';
  };
}

// 示例
const swapExample: HabitSwapDesign = {
  promptRedirect: {
    oldTrigger: '感到无聊时',
    newBinding: '当我感到无聊时，我会做3次深呼吸',
  },
  abilityAdjust: {
    makeNewEasier: [
      '深呼吸随时随地都能做',
      '不需要任何工具',
      '只需要10秒钟',
    ],
    makeOldHarder: [
      '把手机放到另一个房间',
      '设置App使用时间限制',
      '删除最容易上瘾的App',
    ],
  },
  celebration: {
    method: '深呼吸后对自己说"我选择了更好的方式"',
    timing: 'after',
  },
};
```

---

## 七、Phase 5: 体验简化与优化

### 7.1 功能概述

福格原则：**"帮助人们做他们已经想做的事"**、**"感受成功"**

当前系统过于复杂，需要简化。

### 7.2 调整清单

| 调整项 | 当前状态 | 调整方向 | 优先级 |
|-------|---------|---------|-------|
| 进阶分析系统 | 6种复杂图表 | 简化为2-3种核心图表 | P1 |
| 风险预测 | 主动预警 | 改为被动查询 | P1 |
| 周报内容 | 大量数据分析 | 突出成功庆祝 | P1 |
| 动机维护引擎 | 核心功能 | 降级为辅助功能 | P1 |
| 打卡流程 | 记录为主 | 庆祝为主 | P0 |

### 7.3 简化后的仪表板

```
简化后的仪表板（突出成功感）：
┌─────────────────────────────────────────────┐
│                                             │
│  🎉 今日成功                                 │
│  ┌─────────────────────────────────────┐   │
│  │ ✅ 早起 - 第14天！🔥                  │   │
│  │ ✅ 喝水 - 已完成                      │   │
│  │ ⬜ 阅读 - [打卡]                      │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  ⭐ 本周亮点                                 │
│  "你已连续7天全勤！这是你坚持最久的一周！"    │
│                                             │
│  📈 简单统计                                 │
│  本周完成率：85% (+12%) | 最长连续：14天     │
│                                             │
│           [ 查看详细分析 ]                   │
│                                             │
└─────────────────────────────────────────────┘
```

### 7.4 问题解决优先级调整

```typescript
// 当前逻辑（错误）：
// 用户失败 → 分析动机问题 → 生成激励文案

// 调整后逻辑（正确）：
// 用户失败 → 检查提示 → 检查能力 → 最后检查动机

const troubleshootHabit = async (habitId: string) => {
  const habit = await getHabit(habitId);
  const recentLogs = await getRecentLogs(habitId, 7);

  // 第1步：检查提示
  const promptIssues = analyzePromptIssues(habit, recentLogs);
  if (promptIssues.found) {
    return {
      priority: 1,
      category: 'PROMPT',
      message: '试试找一个更可靠的锚点习惯',
      suggestions: promptIssues.suggestions,
    };
  }

  // 第2步：检查能力
  const abilityIssues = analyzeAbilityIssues(habit, recentLogs);
  if (abilityIssues.found) {
    return {
      priority: 2,
      category: 'ABILITY',
      message: '让这个习惯变得更简单一些',
      suggestions: abilityIssues.suggestions,
    };
  }

  // 第3步：检查动机（最后）
  return {
    priority: 3,
    category: 'MOTIVATION',
    message: '让我们重新连接你的愿望',
    suggestions: ['回顾你的愿景', '调整期望'],
  };
};
```

---

## 八、Phase 7: 习惯进阶系统（微习惯到目标习惯）

### 8.1 功能概述

福格原理：
> "不要过早提高标准。让动机来告诉你该做多少。"
> "舒适区边界不是一条直线，它更像股市走势图中起起伏伏的线条。"

**核心设计理念**：
- 微习惯是"最低标准"，用户可以随时做更多
- 进阶是"自然生长"，不是"强制升级"
- 保持灵活性，状态不好时可以回退到最低标准

### 8.2 习惯生长模型

```
目标习惯：每天运动1小时
          ↑
    ┌─────┴─────┐
    │  自然生长  │ ← 用户"想多做"时才升级
    └─────┬─────┘
          │
阶段6：运动30分钟 ←────────────────┐
          ↑                        │
阶段5：运动15分钟                   │
          ↑                        │ 任何时候状态不好
阶段4：走出家门走10分钟              │ 都可以回退到
          ↑                        │ 微习惯最低标准
阶段3：穿好运动装备走出家门           │
          ↑                        │
阶段2：穿上运动服和鞋                │
          ↑                        │
阶段1：把运动鞋放在门口（微习惯）──────┘
```

### 8.3 功能清单

| 功能点 | 描述 | 优先级 |
|-------|------|-------|
| 阶段路径设计 | AI为目标习惯设计渐进式阶段 | P0 |
| 弹性打卡机制 | 最低标准 vs 实际完成分离 | P0 |
| 自然进阶提示 | 检测用户"想多做"的信号 | P0 |
| 退阶保护 | 状态不好时建议回退 | P1 |
| 进阶庆祝 | 升级阶段时的特殊庆祝 | P1 |
| 习惯繁殖引导 | 发现关联习惯的机会 | P2 |

### 8.4 核心机制设计

#### 8.4.1 阶段路径（AI生成）

```typescript
// src/lib/ai/phase-design.ts

const phaseDesignSchema = z.object({
  targetHabit: z.string(),
  phases: z.array(z.object({
    phase: z.number(),
    name: z.string(),
    microHabit: z.string(),           // 这个阶段的最低标准
    successCriteria: z.string(),      // 什么算完成
    estimatedDuration: z.string(),    // 建议持续时间（仅参考）
    advanceSignals: z.array(z.string()), // 可以进阶的信号
    tips: z.array(z.string()),
  })),
  totalPhases: z.number(),
});

export async function designPhases(
  targetHabit: string,
  currentLevel: string,
  userContext: UserContext,
) {
  const { object } = await generateObject({
    model: 'openai/gpt-4o',
    system: `你是微习惯设计专家。根据福格行为模型，将目标习惯拆解为渐进式阶段。

设计原则：
1. 第一阶段必须是"2分钟规则"内能完成的微习惯
2. 每个阶段的难度提升不超过20%
3. 每个阶段都应该"不可能失败"
4. 阶段之间不设固定时间，由用户自然生长
5. 进阶信号应该是用户主动想多做的迹象

微习惯设计技巧：
- 入门步骤：关注启动行为（穿上运动鞋）
- 缩小规模：缩小行为本身（只做2个俯卧撑）
- 关键：让用户觉得"这也太简单了"`,
    prompt: `目标习惯：${targetHabit}
用户当前水平：${currentLevel}
用户背景：${JSON.stringify(userContext)}

请设计渐进式阶段路径。`,
    schema: phaseDesignSchema,
  });

  return object;
}
```

#### 8.4.2 弹性打卡机制

**核心概念**：区分"最低标准"和"实际完成"

```
┌─────────────────────────────────────────────┐
│  📝 今日打卡：早起                           │
├─────────────────────────────────────────────┤
│                                             │
│  当前阶段：阶段2 - 闹钟响后5分钟内起床        │
│  最低标准：闹钟响后坐起来                     │
│                                             │
│  今天实际做到了什么？                         │
│                                             │
│  ○ 完成最低标准（坐起来了）                  │
│  ○ 超额完成（5分钟内起床了）← 计入进阶信号    │
│  ○ 做得更多（起来后还做了伸展）              │
│                                             │
│  ────────────────────────────────────────   │
│                                             │
│  💡 记住：完成最低标准就是100%成功！          │
│     多做的部分是额外奖励，不是必须的。        │
│                                             │
└─────────────────────────────────────────────┘
```

```typescript
// 打卡数据结构
interface HabitLog {
  // ... 现有字段

  // 弹性打卡
  completionLevel: 'MINIMUM' | 'STANDARD' | 'EXCEEDED';
  actualBehavior: string;      // 用户实际做了什么
  wantedToDoMore: boolean;     // 用户是否想做更多（进阶信号）
  feltEasy: boolean;           // 用户是否觉得很轻松（进阶信号）
}
```

#### 8.4.3 自然进阶检测

```typescript
// src/lib/habit/advance-detection.ts

// 情感标志类型（福格原理）
type EmotionalMarker =
  | 'BOREDOM'      // 厌倦 → 可能需要提升难度
  | 'FRUSTRATION'  // 沮丧 → 难度过高，需要退阶
  | 'AVOIDANCE'    // 逃避 → 行为设计有问题
  | 'PAIN'         // 痛苦 → 立即退阶
  | 'JOY'          // 愉悦 → 继续保持
  | 'PRIDE';       // 自豪 → 可以挑战更多

interface AdvanceSignal {
  type: 'EXCEEDED_OFTEN' | 'FELT_EASY' | 'WANTED_MORE' | 'HIGH_SHINE' | 'BOREDOM';
  strength: number;  // 0-1
  evidence: string;
}

interface RetreatSignal {
  type: 'FRUSTRATION' | 'AVOIDANCE' | 'PAIN' | 'MISSED_DAYS' | 'LOW_PERFORMANCE';
  severity: number;  // 0-1
  evidence: string;
}

export function detectAdvanceReadiness(
  habit: Habit,
  recentLogs: HabitLog[],
): { ready: boolean; signals: AdvanceSignal[]; suggestion: string } {

  const signals: AdvanceSignal[] = [];

  // 信号1：经常超额完成
  const exceededCount = recentLogs.filter(
    log => log.completionLevel === 'EXCEEDED'
  ).length;
  if (exceededCount >= 5) {  // 最近7天有5天超额
    signals.push({
      type: 'EXCEEDED_OFTEN',
      strength: exceededCount / 7,
      evidence: `最近7天有${exceededCount}天超额完成`,
    });
  }

  // 信号2：用户表示想做更多
  const wantedMoreCount = recentLogs.filter(log => log.wantedToDoMore).length;
  if (wantedMoreCount >= 3) {
    signals.push({
      type: 'WANTED_MORE',
      strength: wantedMoreCount / 7,
      evidence: `${wantedMoreCount}次表示想做更多`,
    });
  }

  // 信号3：用户觉得很轻松
  const feltEasyCount = recentLogs.filter(log => log.feltEasy).length;
  if (feltEasyCount >= 5) {
    signals.push({
      type: 'FELT_EASY',
      strength: feltEasyCount / 7,
      evidence: `${feltEasyCount}次表示很轻松`,
    });
  }

  // 信号4：发光感评分持续较高
  const avgShine = recentLogs.reduce((sum, log) =>
    sum + (log.shineScore || 0), 0) / recentLogs.length;
  if (avgShine >= 4) {
    signals.push({
      type: 'HIGH_SHINE',
      strength: avgShine / 5,
      evidence: `平均发光感${avgShine.toFixed(1)}分`,
    });
  }

  // 综合判断
  const totalStrength = signals.reduce((sum, s) => sum + s.strength, 0);
  const ready = signals.length >= 2 && totalStrength >= 1.5;

  return {
    ready,
    signals,
    suggestion: ready
      ? '看起来你已经准备好挑战下一阶段了！要试试吗？'
      : '继续保持当前节奏，不用着急进阶。',
  };
}
```

#### 8.4.4 进阶提示界面

```
┌─────────────────────────────────────────────┐
│  🌟 进阶提示                                 │
├─────────────────────────────────────────────┤
│                                             │
│  「早起」习惯 - 当前阶段2                     │
│                                             │
│  我注意到：                                  │
│  ✓ 最近7天有5天你都超额完成了                │
│  ✓ 你3次表示"想做更多"                       │
│  ✓ 你的发光感评分平均4.2分                   │
│                                             │
│  看起来你已经准备好了！                       │
│  要试试进入【阶段3】吗？                      │
│                                             │
│  阶段3：闹钟响后立即起床并喝一杯水            │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │ 💡 记住：你随时可以回到阶段2的          │   │
│  │    最低标准（坐起来就算完成）          │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  [ 试试阶段3 ]     [ 再等等 ]               │
│                                             │
└─────────────────────────────────────────────┘
```

#### 8.4.5 退阶保护机制（含情感标志检测）

福格原著：
> "沮丧、痛苦以及逃避等情绪标志着你的习惯出了问题，可能是难度提升太多、太快。但如果你是对现有习惯感到有些厌倦，那么你或许还需要再提高些难度才行。"

```typescript
// 检测是否需要建议退阶
export function detectRetreatNeed(
  habit: Habit,
  recentLogs: HabitLog[],
): { needRetreat: boolean; signals: RetreatSignal[]; reason: string } {

  const signals: RetreatSignal[] = [];

  // 信号1：情感标志 - 沮丧
  const frustrationCount = recentLogs.filter(
    log => log.emotionalMarker === 'FRUSTRATION'
  ).length;
  if (frustrationCount >= 2) {
    signals.push({
      type: 'FRUSTRATION',
      severity: frustrationCount / 7,
      evidence: `${frustrationCount}次记录感到沮丧`,
    });
  }

  // 信号2：情感标志 - 逃避
  const avoidanceCount = recentLogs.filter(
    log => log.emotionalMarker === 'AVOIDANCE'
  ).length;
  if (avoidanceCount >= 2) {
    signals.push({
      type: 'AVOIDANCE',
      severity: avoidanceCount / 7,
      evidence: `${avoidanceCount}次记录想逃避`,
    });
  }

  // 信号3：情感标志 - 痛苦（严重，单次即触发）
  const painCount = recentLogs.filter(
    log => log.emotionalMarker === 'PAIN'
  ).length;
  if (painCount >= 1) {
    signals.push({
      type: 'PAIN',
      severity: 1.0,  // 最高严重度
      evidence: `记录感到痛苦，需要立即调整`,
    });
  }

  // 信号4：有跳过/未完成的天数
  const missedDays = recentLogs.filter(log => !log.completed).length;
  if (missedDays >= 2) {
    signals.push({
      type: 'MISSED_DAYS',
      severity: missedDays / 7,
      evidence: `最近7天有${missedDays}天未完成`,
    });
  }

  // 信号5：低表现且发光感低
  const lowPerformanceDays = recentLogs.filter(
    log => log.completionLevel === 'MINIMUM' && (log.shineScore || 0) <= 2
  ).length;
  if (lowPerformanceDays >= 3) {
    signals.push({
      type: 'LOW_PERFORMANCE',
      severity: lowPerformanceDays / 7,
      evidence: `${lowPerformanceDays}天仅完成最低标准且感觉不好`,
    });
  }

  // 综合判断
  const totalSeverity = signals.reduce((sum, s) => sum + s.severity, 0);
  const needRetreat = signals.some(s => s.type === 'PAIN') ||
                      (signals.length >= 2 && totalSeverity >= 1.0);

  return {
    needRetreat,
    signals,
    reason: needRetreat
      ? '最近似乎有些吃力，要回到上一阶段吗？记住，保持连贯比追求进度更重要。'
      : '',
  };
}
```

```
退阶提示界面：
┌─────────────────────────────────────────────┐
│  💚 温馨提示                                 │
├─────────────────────────────────────────────┤
│                                             │
│  最近「早起」习惯似乎有些吃力。              │
│                                             │
│  这很正常！生活中总有起伏。                  │
│  福格说："保持连贯比追求进度更重要。"         │
│                                             │
│  要暂时回到【阶段2】吗？                     │
│  这不是退步，是聪明的调整。                  │
│                                             │
│  [ 回到阶段2 ]     [ 再坚持看看 ]            │
│                                             │
└─────────────────────────────────────────────┘
```

### 8.5 数据模型扩展

```prisma
// 扩展 Habit 模型
model Habit {
  // ... 现有字段

  // 阶段相关
  targetHabit       String?     // 最终目标习惯描述
  phases            Json?       // 阶段配置数组
  currentPhase      Int         @default(1)
  phaseStartedAt    DateTime?   // 当前阶段开始时间

  // 进阶历史
  phaseHistory      PhaseHistory[]
}

// 阶段变更历史
model PhaseHistory {
  id          String   @id @default(cuid())
  habitId     String
  habit       Habit    @relation(fields: [habitId], references: [id])

  fromPhase   Int
  toPhase     Int
  changeType  PhaseChangeType  // ADVANCE | RETREAT
  reason      String?          // 变更原因
  signals     Json?            // 触发信号

  changedAt   DateTime @default(now())

  @@index([habitId])
}

enum PhaseChangeType {
  ADVANCE   // 进阶
  RETREAT   // 退阶
}

// 扩展 HabitLog
model HabitLog {
  // ... 现有字段

  // 弹性打卡
  completionLevel   CompletionLevel  @default(MINIMUM)
  actualBehavior    String?
  wantedToDoMore    Boolean          @default(false)
  feltEasy          Boolean          @default(false)

  // 情感标志（福格原理）
  emotionalMarker   EmotionalMarker?
}

enum CompletionLevel {
  MINIMUM   // 完成最低标准
  STANDARD  // 完成当前阶段标准
  EXCEEDED  // 超额完成
}

// 情感标志枚举
enum EmotionalMarker {
  BOREDOM      // 厌倦 → 可能需要提升难度
  FRUSTRATION  // 沮丧 → 难度过高
  AVOIDANCE    // 逃避 → 行为设计问题
  PAIN         // 痛苦 → 立即退阶
  JOY          // 愉悦 → 继续保持
  PRIDE        // 自豪 → 可以挑战更多
}
```

### 8.6 API 设计

```typescript
// src/server/api/routers/phase.ts

export const phaseRouter = createTRPCRouter({
  // 为习惯设计阶段路径
  designPhases: protectedProcedure
    .input(z.object({
      habitId: z.string(),
      targetHabit: z.string(),
      currentLevel: z.string(),
    }))
    .mutation(async ({ ctx, input }) => {
      const phases = await designPhases(
        input.targetHabit,
        input.currentLevel,
        { userId: ctx.session.user.id },
      );

      return ctx.db.habit.update({
        where: { id: input.habitId },
        data: {
          targetHabit: input.targetHabit,
          phases: phases.phases,
        },
      });
    }),

  // 检测进阶准备度
  checkAdvanceReadiness: protectedProcedure
    .input(z.object({ habitId: z.string() }))
    .query(async ({ ctx, input }) => {
      const habit = await ctx.db.habit.findUnique({
        where: { id: input.habitId },
      });
      const logs = await ctx.db.habitLog.findMany({
        where: { habitId: input.habitId },
        orderBy: { loggedAt: 'desc' },
        take: 7,
      });

      return detectAdvanceReadiness(habit!, logs);
    }),

  // 执行进阶
  advancePhase: protectedProcedure
    .input(z.object({
      habitId: z.string(),
      signals: z.array(z.string()),
    }))
    .mutation(async ({ ctx, input }) => {
      const habit = await ctx.db.habit.findUnique({
        where: { id: input.habitId },
      });

      // 记录历史
      await ctx.db.phaseHistory.create({
        data: {
          habitId: input.habitId,
          fromPhase: habit!.currentPhase,
          toPhase: habit!.currentPhase + 1,
          changeType: 'ADVANCE',
          signals: input.signals,
        },
      });

      // 更新阶段
      return ctx.db.habit.update({
        where: { id: input.habitId },
        data: {
          currentPhase: { increment: 1 },
          phaseStartedAt: new Date(),
        },
      });
    }),

  // 执行退阶
  retreatPhase: protectedProcedure
    .input(z.object({
      habitId: z.string(),
      reason: z.string().optional(),
    }))
    .mutation(async ({ ctx, input }) => {
      const habit = await ctx.db.habit.findUnique({
        where: { id: input.habitId },
      });

      if (habit!.currentPhase <= 1) {
        throw new Error('已经是最初阶段');
      }

      await ctx.db.phaseHistory.create({
        data: {
          habitId: input.habitId,
          fromPhase: habit!.currentPhase,
          toPhase: habit!.currentPhase - 1,
          changeType: 'RETREAT',
          reason: input.reason,
        },
      });

      return ctx.db.habit.update({
        where: { id: input.habitId },
        data: {
          currentPhase: { decrement: 1 },
          phaseStartedAt: new Date(),
        },
      });
    }),
});
```

### 8.7 与庆祝系统的整合

进阶成功时触发特殊庆祝：

```
┌─────────────────────────────────────────────┐
│                                             │
│     🎊 恭喜！你进入了新阶段！                 │
│                                             │
│     「早起」习惯                             │
│     阶段2 → 阶段3                            │
│                                             │
│     [🎆 烟花动画]                            │
│                                             │
│     新的最低标准：                           │
│     "闹钟响后立即起床并喝一杯水"              │
│                                             │
│     记住：状态不好时随时可以回到              │
│     "坐起来就算完成"                         │
│                                             │
│     [ 开始新阶段 ]                           │
│                                             │
└─────────────────────────────────────────────┘
```

### 8.8 习惯繁殖机制（P2）

福格原著：
> "带着明确的愿望开启习惯设计过程，这样你会自然地形成专属于自己的生长类习惯与繁殖类习惯混合体。"

**两种习惯成长方式**：
- **生长类习惯**：同一习惯逐渐扩大规模（如：喝一口水 → 喝一杯水 → 每天8杯水）
- **繁殖类习惯**：一个习惯引发其他相关习惯（如：早起 → 晨跑 → 健康早餐 → 冥想）

```typescript
// src/lib/ai/habit-proliferation.ts

const proliferationSchema = z.object({
  currentHabit: z.string(),
  relatedHabits: z.array(z.object({
    name: z.string(),
    relationship: z.enum([
      'SAME_TIME',      // 同一时间可以顺便做
      'SAME_LOCATION',  // 同一地点可以做
      'SAME_THEME',     // 同一主题/愿望
      'NATURAL_FOLLOW', // 自然衔接
      'SYNERGY',        // 相互促进
    ]),
    microVersion: z.string(),
    suggestedAnchor: z.string(),
    reason: z.string(),
  })),
  bestNext: z.object({
    habit: z.string(),
    reason: z.string(),
  }),
});

export async function suggestProliferation(
  currentHabit: Habit,
  userAspiration: string,
  existingHabits: Habit[],
) {
  const { object } = await generateObject({
    model: 'openai/gpt-4o',
    system: `你是习惯繁殖专家。根据用户当前稳定的习惯，推荐可以"繁殖"出来的相关习惯。

繁殖原则：
1. 新习惯应与现有习惯有自然关联
2. 新习惯可以利用现有习惯作为锚点
3. 新习惯应服务于用户的整体愿望
4. 避免推荐用户已有的习惯

繁殖时机：
- 当前习惯已稳定（连续7天以上）
- 用户表达想做更多
- 发现自然的习惯衔接机会`,
    prompt: `当前稳定习惯：${currentHabit.name}
用户愿望：${userAspiration}
已有习惯：${existingHabits.map(h => h.name).join('、')}

请推荐可以从当前习惯"繁殖"出来的新习惯。`,
    schema: proliferationSchema,
  });

  return object;
}
```

**繁殖提示界面**：

```
┌─────────────────────────────────────────────┐
│  🌱 习惯繁殖机会                              │
├─────────────────────────────────────────────┤
│                                             │
│  你的「早起」习惯已经稳定了14天！🎉            │
│                                             │
│  这个习惯可以自然地"繁殖"出新习惯：           │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │ 🏃 晨间伸展                          │   │
│  │    关系：自然衔接                     │   │
│  │    配方：在我起床后，我会做2个伸展     │   │
│  │    原因：利用早起后的几分钟           │   │
│  ├─────────────────────────────────────┤   │
│  │ 🥤 喝一杯温水                        │   │
│  │    关系：同一时间顺便做               │   │
│  │    配方：在我伸展后，我会喝一杯温水    │   │
│  │    原因：为身体补水，启动新陈代谢      │   │
│  └─────────────────────────────────────┘   │
│                                             │
│  想尝试哪个新习惯？                          │
│                                             │
│  [ 晨间伸展 ]  [ 喝温水 ]  [ 暂时不需要 ]     │
│                                             │
└─────────────────────────────────────────────┘
```

**繁殖触发条件**：

```typescript
// 检测是否可以建议习惯繁殖
export function checkProliferationOpportunity(
  habit: Habit,
  logs: HabitLog[],
): { canProliferate: boolean; reason: string } {

  // 条件1：习惯已稳定（至少连续7天）
  const consecutiveDays = calculateConsecutiveDays(logs);
  if (consecutiveDays < 7) {
    return { canProliferate: false, reason: '习惯尚未稳定' };
  }

  // 条件2：用户没有太多进行中的习惯（避免过载）
  // 这个检查在调用时进行

  // 条件3：用户情感状态良好
  const recentShineAvg = logs.slice(0, 7).reduce(
    (sum, log) => sum + (log.shineScore || 0), 0
  ) / 7;
  if (recentShineAvg < 3) {
    return { canProliferate: false, reason: '先稳固当前习惯' };
  }

  return {
    canProliferate: true,
    reason: `「${habit.name}」已稳定${consecutiveDays}天，可以考虑繁殖新习惯`,
  };
}
```

---

## 九、Phase 8: 成就徽章系统（增强庆祝）

### 9.1 功能概述

成就徽章作为庆祝系统的延伸，提供更长周期的成就感反馈。

### 9.2 成就类型设计

| 类别 | 徽章名称 | 解锁条件 | 稀有度 |
|-----|---------|---------|-------|
| **起步系列** | 🌱 萌芽 | 创建第一个习惯 | 普通 |
| | 👣 第一步 | 完成首次打卡 | 普通 |
| | 🎉 初次发光 | 首次记录发光感评分 | 普通 |
| **连续系列** | 🔥 小火苗 | 单个习惯连续7天 | 普通 |
| | 🔥🔥 燃烧吧 | 单个习惯连续21天 | 稀有 |
| | 🔥🔥🔥 永恒之火 | 单个习惯连续66天 | 史诗 |
| | 💎 钻石意志 | 单个习惯连续100天 | 传说 |
| **庆祝系列** | ✨ 发光新手 | 累计庆祝10次 | 普通 |
| | 🌟 庆祝达人 | 累计庆祝50次 | 稀有 |
| | 💫 发光大师 | 平均发光感评分≥4 | 史诗 |
| **全勤系列** | ⭐ 完美日 | 单日所有习惯全部完成 | 普通 |
| | 🏆 完美周 | 连续7天完美日 | 稀有 |
| **特殊系列** | 💪 逆袭者 | 从中断恢复并再次连续7天 | 稀有 |
| | 🧪 配方设计师 | 完成5个微习惯配方设计 | 普通 |

### 9.3 数据模型设计

```prisma
enum BadgeRarity {
  COMMON     // 普通
  RARE       // 稀有
  EPIC       // 史诗
  LEGENDARY  // 传说
}

model Badge {
  id              String      @id @default(cuid())
  code            String      @unique
  name            String
  description     String
  icon            String
  rarity          BadgeRarity
  category        String
  unlockCondition Json

  userBadges      UserBadge[]
  createdAt       DateTime    @default(now())
}

model UserBadge {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId    String
  badge      Badge    @relation(fields: [badgeId], references: [id])
  unlockedAt DateTime @default(now())
  habitId    String?

  @@unique([userId, badgeId])
  @@index([userId])
}
```

---

## 十、开发优先级排序

### 10.1 总体优先级

```
Week 1-2:   Phase 1 - 庆祝系统 (P0)
            └── 庆祝方式库、打卡庆祝流程、发光感评分、动画反馈

Week 3-4:   Phase 2 - 习惯创建重构 (P0)
            └── 愿望引导、行为集群、焦点地图、双策略

Week 5-6:   Phase 3 - 提示系统升级 (P0/P1)
            └── 日程清单、锚点匹配、锚点验证

Week 7-8:   Phase 4 - 戒除流程标准化 (P0/P1)
            └── 三步流程、提示策略、能力障碍

Week 9-10:  Phase 5 - 体验简化 (P1)
            └── 仪表板简化、逻辑调整

Week 11-14: Phase 7 - 习惯进阶系统 (P0/P1)
            └── 阶段路径设计、弹性打卡、进阶检测、退阶保护

Week 15-16: Phase 8 - 成就徽章 (P1)
            └── 徽章系统、解锁逻辑
```

### 10.2 P0 功能清单（必须完成）

| Phase | 功能 | 预估工时 |
|-------|------|---------|
| 1 | 庆祝方式库 | 8h |
| 1 | 打卡庆祝引导 | 16h |
| 1 | 发光感评分 | 4h |
| 1 | 庆祝动画反馈 | 8h |
| 2 | 愿望明确引导 | 8h |
| 2 | 行为集群探索 | 12h |
| 2 | 焦点地图评估 | 16h |
| 2 | 双策略选择 | 8h |
| 3 | 日程清单工具 | 12h |
| 3 | 锚点智能匹配 | 16h |
| 4 | 戒除流程引导 | 12h |
| 4 | 提示策略工具 | 8h |
| 4 | 能力障碍设计 | 8h |
| 7 | 阶段路径AI设计 | 16h |
| 7 | 弹性打卡机制 | 12h |
| 7 | 自然进阶检测 | 12h |
| 7 | 退阶保护机制 | 8h |
| **合计** | | **184h** |

---

## 十一、需要修改的关键文件

```
prisma/schema.prisma
├── 新增 CelebrationMethod, UserCelebration
├── 新增 Aspiration, BehaviorCluster
├── 新增 PhaseHistory, PhaseChangeType枚举, CompletionLevel枚举
├── 新增 Badge, UserBadge
├── 扩展 HabitLog (庆祝+弹性打卡字段)
└── 扩展 Habit (配方+阶段相关字段)

src/server/api/routers/
├── celebration.ts     - 新增：庆祝系统
├── aspiration.ts      - 新增：愿望和行为集群
├── phase.ts           - 新增：习惯进阶系统
├── badge.ts           - 新增：成就徽章
├── habit.ts           - 修改：习惯创建流程
└── log.ts             - 修改：打卡触发庆祝（含弹性打卡）

src/lib/
├── celebration/
│   └── methods.ts     - 新增：100种庆祝方式
├── ai/
│   ├── focus-map.ts   - 新增：焦点地图生成
│   ├── anchor-matching.ts - 新增：锚点匹配
│   ├── phase-design.ts    - 新增：阶段路径AI设计
│   └── troubleshoot.ts    - 新增：问题诊断
├── habit/
│   ├── advance-detection.ts - 新增：进阶信号检测
│   └── retreat-detection.ts - 新增：退阶保护检测
└── achievement/
    └── engine.ts      - 新增：成就触发引擎

src/components/
├── celebration/
│   ├── method-picker.tsx    - 新增：庆祝方式选择器
│   ├── shine-rating.tsx     - 新增：发光感评分
│   └── confetti.tsx         - 新增：彩纸动画
├── habit-creation/
│   ├── aspiration-step.tsx  - 新增：愿望明确步骤
│   ├── behavior-cluster.tsx - 新增：行为集群
│   ├── focus-map.tsx        - 新增：焦点地图
│   └── recipe-card.tsx      - 新增：配方卡片
├── anchor/
│   ├── daily-routine.tsx    - 新增：日程清单
│   └── anchor-matcher.tsx   - 新增：锚点匹配器
├── phase/
│   ├── phase-path.tsx       - 新增：阶段路径展示
│   ├── flexible-checkin.tsx - 新增：弹性打卡界面
│   ├── advance-prompt.tsx   - 新增：进阶提示
│   └── retreat-prompt.tsx   - 新增：退阶提示
└── break-habit/
    └── three-step-flow.tsx  - 新增：三步戒除流程

src/app/(app)/
├── habits/new/page.tsx      - 重构：新的创建流程
├── celebrations/page.tsx    - 新增：庆祝方式管理
└── achievements/page.tsx    - 新增：成就中心
```

---

## 十二、验收标准

### 12.1 核心指标

| 指标 | v1.5 基线 | v2.0 目标 |
|-----|----------|----------|
| 打卡后庆祝完成率 | 0% | ≥ 70% |
| 用户平均发光感评分 | N/A | ≥ 3.5/5 |
| 习惯配方完整率（含锚点+行为+庆祝） | - | ≥ 90% |
| 7天留存率 | - | 提升 15% |
| 打卡完成率 | - | 提升 20% |

### 12.2 功能验收

**Phase 1 庆祝系统**
- [ ] 每次打卡后必须触发庆祝引导
- [ ] 庆祝支持三个时机（想起时/执行中/完成后）
- [ ] 32种肯定语言框架在周报和AI教练中应用

**Phase 2 习惯创建**
- [ ] 习惯创建必须经过愿望明确和焦点地图筛选
- [ ] 所有习惯必须有标准配方（锚点+行为+庆祝）
- [ ] 新用户引导包含毛伊习惯
- [ ] 创建流程包含去激励因素识别与移除

**Phase 4 戒除系统**
- [ ] 戒除习惯必须提供三步标准流程（提示→能力→动机）
- [ ] 习惯替换流程（阶段3）完整实现
- [ ] 问题解决建议按"提示→能力→动机"顺序

**Phase 7 进阶系统**
- [ ] 习惯进阶系统支持弹性打卡（最低标准 vs 实际完成）
- [ ] 进阶提示基于用户"想多做"信号自然触发
- [ ] 退阶保护基于情感标志（沮丧/逃避/痛苦）检测
- [ ] 习惯繁殖机制在稳定习惯后触发

---

## 附录：福格模型核心对照表

| 福格原理 | v1.5 状态 | v2.0 改进 |
|---------|----------|----------|
| **核心模型** | | |
| B=MAP 三要素 | ✅ 基本实现 | 强化提示权重 |
| ABC 三步骤（锚点→行为→庆祝） | ❌ 缺少庆祝 | ✅ Phase 1 |
| **庆祝系统** | | |
| 100种庆祝方式 | ❌ 缺失 | ✅ Phase 1 |
| 发光感追踪 | ❌ 缺失 | ✅ Phase 1 |
| 庆祝三时机（想起/执行中/完成后） | ❌ 缺失 | ✅ Phase 1 |
| 32种肯定成功语言 | ❌ 缺失 | ✅ Phase 1 |
| **习惯创建** | | |
| 愿望明确引导 | ⚠️ 简化版 | ✅ Phase 2 |
| 行为集群探索（挥舞魔法棒） | ❌ 缺失 | ✅ Phase 2 |
| 焦点地图（黄金行为筛选） | ❌ 缺失 | ✅ Phase 2 |
| 入门步骤 vs 缩小规模 | ❌ 未区分 | ✅ Phase 2 |
| 配方演练7-10次 | ❌ 缺失 | ✅ Phase 2 |
| 毛伊习惯（新手引导） | ❌ 缺失 | ✅ Phase 2 |
| 去激励因素识别与移除 | ❌ 缺失 | ✅ Phase 2 |
| **提示系统** | | |
| 锚点三维匹配 | ⚠️ 简化版 | ✅ Phase 3 |
| 日程清单工具 | ❌ 缺失 | ✅ Phase 3 |
| 珍珠习惯 | ❌ 缺失 | ✅ Phase 3 |
| 顺便习惯 | ❌ 缺失 | ✅ Phase 3 |
| **戒除系统** | | |
| 戒除三步法（提示→能力→动机） | ⚠️ 不完整 | ✅ Phase 4 |
| 习惯替换流程（阶段3） | ❌ 缺失 | ✅ Phase 4 |
| **问题解决** | | |
| 问题解决顺序（提示→能力→动机） | ❌ 动机优先 | ✅ Phase 5 |
| **习惯进阶** | | |
| 习惯自然生长（不强制升级） | ❌ 缺失 | ✅ Phase 7 |
| 弹性打卡（最低标准保底） | ❌ 缺失 | ✅ Phase 7 |
| 情感标志检测（沮丧/逃避/痛苦） | ❌ 缺失 | ✅ Phase 7 |
| 舒适区边界起伏（退阶保护） | ❌ 缺失 | ✅ Phase 7 |
| 习惯繁殖（生长类+繁殖类） | ❌ 缺失 | ✅ Phase 7 |

---

**文档版本**: v2.0 迭代计划（福格对齐增强版）
**更新日期**: 2025-12-01
**福格对齐度**: 95%+
**下一步**: 开始 Phase 1 庆祝系统开发
